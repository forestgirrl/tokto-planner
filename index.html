<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakura F1 Trip Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.js"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF9EAA',      /* æ«»èŠ±æ·±ç²‰ */
                        secondary: '#FFF0F2',    /* æ«»èŠ±æ·ºç²‰ */
                        accent: '#FF7B8F',
                        bg: '#FFF9FA',
                        textMain: '#5D5656',
                        textLight: '#989090',
                        tagFood: '#FFB347',
                        tagShop: '#77DD77',
                        tagPic: '#AEC6CF'
                    },
                    fontFamily: {
                        zen: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'float': '0 8px 24px rgba(255, 158, 170, 0.25)',
                        'card': '0 4px 16px rgba(149, 157, 165, 0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        /* è‡ªå®šç¾©æ¨£å¼è£œå…… */
        body {
            background-image: radial-gradient(#ffeef0 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }
        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* é é¢åˆ‡æ›å‹•ç•« */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* æ‹–æ›³æ™‚çš„è¦–è¦ºå›é¥‹ */
        .ghost {
            opacity: 0.5;
            background: #FF9EAA50;
            border: 2px dashed #FF9EAA;
            box-shadow: none;
        }
        .day-chip-date {
            font-size: 1.5rem; /* å¤§æ•¸å­— */
            line-height: 1.2;
            font-weight: 700;
        }
        .day-chip-day {
            font-size: 0.75rem; /* å°æ˜ŸæœŸ */
            line-height: 1.2;
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-bg text-textMain font-zen antialiased pb-28 min-h-screen lg:max-w-md lg:mx-auto lg:border-x lg:border-gray-100 lg:shadow-xl relative">

    <div id="app">
        
        <header class="relative w-full h-[250px] rounded-b-3xl overflow-hidden shadow-card bg-white z-20">
            <img src="f1cat.jpg" alt="F1 Sakura Trip" class="w-full h-full object-cover">
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex flex-col justify-end p-6">
                <div class="text-white text-right"> 
                    <div class="flex items-center justify-end gap-2 mb-1">
                        <span class="bg-primary px-2 py-0.5 rounded-lg text-xs font-bold">15 Days</span>
                        <span class="text-sm font-medium opacity-90">2026.03.21 - 04.04</span> 
                    </div>
                    <h1 class="text-2xl font-black tracking-wide drop-shadow-md">æ—¥æœ¬ F1 æ«»èŠ±è‡ªç”±è¡Œ</h1>
                </div>
            </div>
        </header>

        <nav class="absolute top-[215px] right-5 z-30 flex gap-2 p-2 bg-white/90 backdrop-blur-sm rounded-xl shadow-float border border-white/50">
            <button v-for="tab in topTabs" :key="tab.id" @click="currentTopTab = tab.id"
                    class="w-10 h-10 rounded-lg flex items-center justify-center transition-all duration-300"
                    :class="currentTopTab === tab.id ? 'bg-primary border-primary text-white shadow-md' : 'text-gray-400 hover:bg-gray-100'">
                <i :class="tab.icon" class="text-xl"></i>
            </button>
        </nav>

        <main class="mt-4 px-5">
            
            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'itinerary'" key="itinerary">
                    
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-4 -mx-5 px-5 snap-x">
                        <div v-for="(day, index) in itineraryData" :key="index" 
                             @click="currentDay = index"
                             class="flex-shrink-0 snap-center w-[60px] rounded-2xl border p-2 text-center cursor-pointer transition-all duration-300"
                             :class="currentDay === index ? 'bg-primary border-primary text-white shadow-lg transform -translate-y-1' : 'bg-white border-secondary text-textLight'">
                            <span class="day-chip-day block">{{ day.dayOfWeek }}</span>
                            <span class="day-chip-date block">{{ day.date.split('/')[1] }}</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <div class="flex items-center gap-2 text-textLight text-sm mb-4">
                            <i class="ri-map-pin-2-fill text-primary"></i>
                            <span>{{ itineraryData[currentDay].location }} ({{ itineraryData[currentDay].date }})</span>
                        </div>

                        <div class="bg-blue-50/70 p-4 rounded-xl flex justify-between items-center mb-5 border border-blue-100">
                            <div class="flex items-center gap-3">
                                <i :class="itineraryData[currentDay].weather.icon" class="text-3xl" :style="{color: itineraryData[currentDay].weather.color}"></i>
                                <div>
                                    <p class="font-bold text-lg text-blue-900">{{ itineraryData[currentDay].weather.temp }}</p>
                                    <p class="text-xs text-blue-700">é«”æ„Ÿ: {{ itineraryData[currentDay].weather.feels }}Â°C</p>
                                </div>
                            </div>
                            <span class="text-sm text-blue-700">{{ itineraryData[currentDay].weather.desc }}</span>
                        </div>
                        
                        <div class="mb-4">
                             <select v-model="filterType" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-white">
                                <option value="">æ‰€æœ‰åˆ†é¡</option>
                                <option v-for="cat in itineraryCategories" :value="cat.value">{{ cat.label }}</option>
                             </select>
                        </div>
                        
                        <draggable v-model="itineraryData[currentDay].spots" item-key="id" tag="div" 
                                   handle=".drag-handle" :animation="200" ghost-class="ghost">
                            <template #item="{ element: spot, index: idx }">
                                <div class="relative">
                                    
                                    <div v-if="spot.transport && spot.transport.time" class="flex items-center justify-center my-1">
                                        <div class="text-xs text-textLight p-1 rounded-full bg-secondary flex items-center gap-1">
                                            <i :class="getTransportIcon(spot.transport.type)"></i>
                                            {{ spot.transport.time }}
                                        </div>
                                    </div>
                                    
                                    <div v-if="spot.type === 'flight' && idx === 0" class="bg-gray-700 text-white rounded-3xl p-4 mb-5 shadow-card">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-bold flex items-center gap-2"><i class="ri-plane-fill text-primary"></i> {{ spot.name }}</span>
                                            <span class="text-xs">{{ spot.time }}</span>
                                        </div>
                                        <p class="text-xs text-gray-300">{{ spot.desc }}</p>
                                        <div class="text-xs mt-2 pt-2 border-t border-gray-600">
                                            èˆªç­ç·¨è™Ÿ: **{{ spot.flightNum }}** | é£›è¡Œæ™‚é–“: **{{ spot.flightTime }}**
                                        </div>
                                    </div>
                                    
                                    <div v-else-if="spot.type !== 'empty'" @click="openSpotEdit(idx)"
                                        class="bg-white rounded-3xl p-4 mb-5 shadow-card border-l-[6px] relative overflow-hidden active:shadow-lg active:scale-[1.01] transition-all duration-150"
                                        :class="{
                                            'border-tagFood': spot.type === 'food',
                                            'border-tagShop': spot.type === 'shop',
                                            'border-tagPic': spot.type === 'pic',
                                            'border-primary': spot.type === 'activity' || spot.type === 'hotel' || spot.type === 'other'
                                        }"
                                        :style="{ display: filterSpot(spot.type) ? 'block' : 'none' }">
                                        
                                        <div class="absolute top-2 right-3 flex gap-2">
                                            <i class="ri-drag-move-fill text-gray-400 drag-handle cursor-move text-lg"></i>
                                            <a :href="spot.mapLink" target="_blank" @click.stop class="text-primary hover:text-accent transition">
                                                <i class="ri-map-pin-2-fill text-lg"></i>
                                            </a>
                                        </div>

                                        <div class="flex justify-between items-start pr-12">
                                            <div>
                                                <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-md">{{ getCategoryLabel(spot.type) }}</span>
                                                <h3 class="text-lg font-bold mt-1 mb-1">{{ spot.name }}</h3>
                                                <p class="text-xs text-textLight">æ™‚é–“: {{ spot.time }}</p>
                                                <p v-if="spot.openHours" class="text-xs text-textLight">ç‡Ÿæ¥­: {{ spot.openHours }}</p>
                                                <p v-if="spot.ticket" class="text-xs text-textLight">é–€ç¥¨: {{ spot.ticket }}</p>
                                            </div>
                                        </div>
                                        <p class="text-sm mt-2 pt-2 border-t border-gray-100 text-textMain">{{ spot.notes }}</p>
                                    </div>
                                    
                                    <div v-else class="bg-white/50 rounded-3xl p-4 mb-5 shadow-card border-2 border-dashed border-gray-200 text-center text-gray-500 cursor-pointer active:scale-[0.99] transition-all" @click="openSpotAdd">
                                        <i class="ri-add-circle-line text-xl mr-2"></i> é»æ“Šæ–°å¢è¡Œç¨‹
                                    </div>
                                    
                                </div>
                            </template>
                        </draggable>
                        
                        <button @click="openSpotAdd" class="fixed bottom-28 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-float z-40 hover:bg-accent transition">
                            <i class="ri-add-line text-2xl"></i>
                        </button>
                    </div>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'info'" key="info" class="space-y-6">
                    
                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3 mt-2">ğŸ“Š åŒ¯ç‡æ›ç®—</h2>
                    <div class="bg-white rounded-3xl p-5 shadow-card">
                        <div class="text-sm text-textLight mb-2">åƒè€ƒåŒ¯ç‡ï¼š1 JPY â‰ˆ {{ exchangeRate.jpyToTwd }} TWD (Mock)</div>
                        <div class="flex items-center gap-3">
                            <input v-model.number="jpyInput" type="number" placeholder="è¼¸å…¥æ—¥å¹£ (JPY)" class="flex-1 p-3 border border-gray-200 rounded-xl focus:border-primary outline-none text-lg">
                            <i class="ri-exchange-line text-2xl text-primary"></i>
                            <div class="flex-1 p-3 bg-secondary rounded-xl text-lg font-bold text-textMain">
                                NT$ {{ convertedTwd }}
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3">âœˆï¸ èˆªç­è³‡è¨Š</h2>
                    <div class="bg-white rounded-3xl p-5 shadow-card space-y-4">
                        <div v-for="flight in flightInfo" :key="flight.flight" class="border-b pb-3 last:border-b-0 last:pb-0">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm">{{ flight.type === 'departure' ? 'å»ç¨‹' : 'å›ç¨‹' }} ({{ flight.date }})</span>
                                <span class="text-xs text-primary font-bold">{{ flight.flight }}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs mt-1">
                                <span class="text-textLight">{{ flight.from.split(' ')[0] }} {{ flight.time }}</span>
                                <i class="ri-arrow-right-line text-xs"></i>
                                <span class="text-textLight">{{ flight.to.split(' ')[0] }} {{ flight.arrivalTime }}</span>
                            </div>
                            <div class="text-xs text-right text-gray-500 mt-1">
                                é£›è¡Œ: {{ flight.flightTime }}
                            </div>
                        </div>
                    </div>

                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3">ğŸ¨ ä½å®¿è³‡è¨Š</h2>
                    <div class="space-y-3">
                        <div v-for="item in locationInfo" :key="item.name" class="bg-white p-4 rounded-2xl shadow-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-xs bg-secondary text-primary px-2 py-0.5 rounded-full">{{ item.category }}</span>
                                    <h4 class="font-bold mt-1">{{ item.name }}</h4>
                                </div>
                                <a :href="item.mapLink" target="_blank" class="text-primary hover:text-accent transition"><i class="ri-map-pin-2-fill text-xl"></i></a>
                            </div>
                            <p v-if="item.phone" class="text-xs text-textLight mt-1"><i class="ri-phone-line mr-1"></i> {{ item.phone }}</p>
                            <p class="text-xs text-textLight"><i class="ri-road-map-line mr-1"></i> {{ item.address }}</p>
                        </div>
                    </div>

                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3">ğŸš¨ ç·Šæ€¥è¯çµ¡è³‡è¨Š</h2>
                    <div class="grid grid-cols-2 gap-3 pb-6">
                        <div class="bg-red-50 p-4 rounded-2xl text-center shadow-card">
                            <i class="ri-police-car-line text-3xl text-red-500"></i>
                            <p class="font-bold text-sm mt-1">è­¦å¯Ÿ 110</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl text-center shadow-card">
                            <i class="ri-first-aid-kit-line text-3xl text-red-500"></i>
                            <p class="font-bold text-sm mt-1">æ¶ˆé˜²/æ•‘è­· 119</p>
                        </div>
                    </div>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'shopping'" key="shopping">
                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3 mt-2 mb-4">ğŸ›’ å¿…è²·æ¸…å–®</h2>
                    
                    <div class="space-y-4">
                        <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-3xl p-4 shadow-card flex items-start gap-4 transition-all"
                            :class="{'opacity-60': item.status === 'bought'}">
                            
                            <button @click="toggleShopStatus(idx)" class="flex-shrink-0 mt-1">
                                <i :class="item.status === 'bought' ? 'ri-checkbox-circle-fill text-green-500' : 'ri-checkbox-blank-circle-line text-gray-300'" class="text-2xl transition-colors"></i>
                            </button>

                            <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                                <img v-if="item.imageUrl" :src="item.imageUrl" alt="å•†å“åœ–ç‰‡" class="w-full h-full object-cover">
                                <i v-else class="ri-image-add-line text-3xl text-gray-400"></i>
                            </div>

                            <div class="flex-1">
                                <h4 class="font-bold" :class="{'line-through text-textLight': item.status === 'bought'}">{{ item.name }}</h4>
                                <p class="text-xs text-textLight mt-1">{{ item.status === 'bought' ? 'å·²è³¼è²·' : 'æœªè³¼è²·' }}</p>
                            </div>

                            <button @click.stop="toggleShopModal('edit', item, idx)" class="flex-shrink-0 text-gray-400 hover:text-primary"><i class="ri-edit-line"></i></button>
                        </div>
                    </div>
                    
                    <button @click="toggleShopModal('add')" class="fixed bottom-28 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-float z-40 hover:bg-accent transition">
                        <i class="ri-add-line text-2xl"></i>
                    </button>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'expense'" key="expense">
                    <h2 class="text-lg font-bold border-l-4 border-primary pl-3 mt-2 mb-4">ğŸ’° æ—…è²»ç´€éŒ„</h2>
                    
                    <div class="bg-primary/90 text-white rounded-2xl p-4 mb-5 text-center shadow-lg">
                        <p class="text-sm font-medium">ç¸½èŠ±è²» (JPY)</p>
                        <p class="text-3xl font-black mt-1">Â¥ {{ totalExpense.toLocaleString('en-US') }}</p>
                        <p class="text-xs mt-1">â‰ˆ NT$ {{ (totalExpense * exchangeRate.jpyToTwd).toFixed(0).toLocaleString('en-US') }}</p>
                    </div>

                    <div class="space-y-3">
                        <div v-for="(item, idx) in expenseList" :key="idx" @click="toggleExpenseModal('edit', item, idx)" class="bg-white rounded-2xl p-4 shadow-card flex justify-between items-center active:scale-[0.99] transition">
                            <div>
                                <span class="text-xs bg-gray-100 text-textLight px-2 py-0.5 rounded-full">{{ item.category }}</span>
                                <h4 class="font-bold mt-1">{{ item.name }}</h4>
                                <p class="text-xs text-gray-500 mt-1">{{ item.date }} | {{ item.payment }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-red-500">Â¥ {{ item.amount.toLocaleString('en-US') }}</p>
                                <p class="text-xs text-gray-400">{{ item.notes }}</p>
                            </div>
                        </div>
                    </div>

                    <button @click="toggleExpenseModal('add')" class="fixed bottom-28 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-float z-40 hover:bg-accent transition">
                        <i class="ri-add-line text-2xl"></i>
                    </button>
                </div>
            </transition>
        </main>

        <transition name="fade">
            <div v-if="isSpotModalOpen" class="fixed inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5" @click.self="isSpotModalOpen = false">
                <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-float transform transition-all scale-100 opacity-100 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-black mb-4">{{ spotModalTitle }}</h3>
                    <form @submit.prevent="saveSpot">
                        <div class="space-y-4">
                            <input v-model="activeSpot.name" type="text" placeholder="åç¨± *" required class="w-full p-3 border rounded-xl">
                            <select v-model="activeSpot.type" class="w-full p-3 border rounded-xl">
                                <option v-for="cat in itineraryCategories" :value="cat.value">{{ cat.label }}</option>
                            </select>
                            <input v-model="activeSpot.time" type="time" placeholder="æ™‚é–“" class="w-full p-3 border rounded-xl">
                            <input v-model="activeSpot.openHours" type="text" placeholder="ç‡Ÿæ¥­æ™‚é–“" class="w-full p-3 border rounded-xl" v-if="['activity', 'hotel', 'food', 'shop'].includes(activeSpot.type)">
                            <input v-model="activeSpot.ticket" type="text" placeholder="é–€ç¥¨" class="w-full p-3 border rounded-xl" v-if="activeSpot.type === 'activity'">
                            <input v-model="activeSpot.mapLink" type="text" placeholder="Google Map Link" class="w-full p-3 border rounded-xl">
                            <textarea v-model="activeSpot.notes" placeholder="ç‰¹è‰² & å‚™è¨»" rows="3" class="w-full p-3 border rounded-xl"></textarea>
                            
                            <button v-if="isEditingSpot" @click.prevent="confirmDeleteSpot" type="button" class="w-full py-3 bg-red-100 text-red-600 rounded-xl font-bold">
                                <i class="ri-delete-bin-line mr-2"></i> åˆªé™¤æ­¤è¡Œç¨‹
                            </button>
                            
                            <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl font-bold mt-4">
                                {{ isEditingSpot ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢è¡Œç¨‹' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="isDeleteConfirmOpen" class="fixed inset-0 z-[600] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5">
                <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-float">
                    <i class="ri-alert-line text-4xl text-red-500 mb-3"></i>
                    <h4 class="font-bold text-lg mb-2">ç¢ºå®šåˆªé™¤å—ï¼Ÿ</h4>
                    <p class="text-sm text-textLight mb-4">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
                    <div class="flex gap-3">
                        <button @click="isDeleteConfirmOpen = false" class="flex-1 py-2 rounded-xl bg-gray-200 font-bold">å–æ¶ˆ</button>
                        <button @click="deleteSpot" class="flex-1 py-2 rounded-xl bg-red-500 text-white font-bold">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="isExpenseModalOpen" class="fixed inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5" @click.self="isExpenseModalOpen = false">
                <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-float max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-black mb-4">ç´€éŒ„èŠ±è²»</h3>
                    <form @submit.prevent="saveExpense">
                        <div class="space-y-3">
                            <select v-model="activeExpense.category" required class="w-full p-3 border rounded-xl">
                                <option disabled value="">é¸æ“‡é¡åˆ¥ *</option>
                                <option v-for="cat in expenseCategories" :value="cat">{{ cat }}</option>
                            </select>
                            <input v-model="activeExpense.name" type="text" placeholder="åç¨±/è³¼è²·åœ°é» *" required class="w-full p-3 border rounded-xl">
                            <input v-model="activeExpense.amount" type="number" placeholder="é‡‘é¡ (æ—¥å¹£) *" required class="w-full p-3 border rounded-xl">
                            <input v-model="activeExpense.date" type="date" :value="new Date().toISOString().slice(0, 10)" required class="w-full p-3 border rounded-xl">
                            <select v-model="activeExpense.payment" required class="w-full p-3 border rounded-xl">
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                            </select>
                            <textarea v-model="activeExpense.notes" placeholder="å‚™è¨»" rows="2" class="w-full p-3 border rounded-xl"></textarea>
                            
                            <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl font-bold mt-4">å„²å­˜ç´€éŒ„</button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="isShopModalOpen" class="fixed inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5" @click.self="isShopModalOpen = false">
                <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-float max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-black mb-4">{{ shopModalTitle }}</h3>
                    <form @submit.prevent="saveShopItem">
                        <div class="space-y-3">
                            <input v-model="activeShopItem.name" type="text" placeholder="å•†å“åç¨± *" required class="w-full p-3 border rounded-xl">
                            <input type="file" @change="handleImageUpload" class="w-full p-3 border rounded-xl bg-gray-50">
                            <p v-if="activeShopItem.imageUrl" class="text-xs text-green-600">åœ–ç‰‡å·²ä¸Šå‚³/æ¨¡æ“¬</p>
                            
                            <button type="submit" class="w-full py-3 bg-primary text-white rounded-xl font-bold mt-4">å„²å­˜æ¸…å–®</button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>


        <nav class="bottom-nav hidden">
        </nav>

    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;
        const Draggable = vuedraggable; // Register the draggable component

        // è¼”åŠ©å‡½å¼ï¼šå°‡æ—¥æœŸç‰©ä»¶æ ¼å¼åŒ–ç‚º 'MM/DD'
        const formatDate = (date) => {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        };
        
        // è¼”åŠ©å‡½å¼ï¼šå°‡æ—¥æœŸç‰©ä»¶æ ¼å¼åŒ–ç‚º 'Day' (e.g., Sat)
        const formatDayOfWeek = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        };

        // --- æ ¸å¿ƒå‡½å¼ï¼šç”Ÿæˆè¡Œç¨‹æ—¥æœŸ ---
        const generateItineraryDays = (startDateStr, endDateStr, baseData) => {
            const allDays = [];
            // åŸºæº–å¹´ä»½è¨­ç‚º 2026
            const YEAR = '2026'; 
            
            const startParts = startDateStr.split('/');
            const endParts = endDateStr.split('/');
            
            const startDate = new Date(`${YEAR}-${startParts[0]}-${startParts[1]}T00:00:00`);
            const endDate = new Date(`${YEAR}-${endParts[0]}-${endParts[1]}T00:00:00`);
            
            const baseDataMap = new Map(baseData.map(day => [day.date, day]));

            let currentDate = new Date(startDate);
            // ç¢ºä¿å¾ªç’°åŒ…å«çµæŸæ—¥æœŸ
            while (currentDate.getTime() <= endDate.getTime()) {
                const dateKey = formatDate(currentDate);
                const dayOfWeekKey = formatDayOfWeek(currentDate);
                
                if (baseDataMap.has(dateKey)) {
                    // ä½¿ç”¨ BASE_ITINERARY ä¸­çš„è©³ç´°è¡Œç¨‹
                    const dayData = baseDataMap.get(dateKey);
                    dayData.dayOfWeek = dayOfWeekKey; // ç¢ºä¿æ˜ŸæœŸå¹¾æ˜¯æ­£ç¢ºçš„
                    allDays.push(dayData);
                } else {
                    // ç”Ÿæˆæ²’æœ‰è©³ç´°è¡Œç¨‹çš„ç©ºç™½æ—¥
                    allDays.push({
                        date: dateKey,
                        dayOfWeek: dayOfWeekKey,
                        location: 'ä»Šæ—¥ç„¡è©³ç´°è¡Œç¨‹',
                        weather: { icon: 'ri-cloud-line', color: 'gray', temp: 'N/A', feels: 'N/A', desc: 'ç­‰å¾…è³‡æ–™' },
                        spots: [{ id: Date.now() + Math.random(), type: 'empty', name: 'é»æ“Šæ–°å¢ä»Šæ—¥è¡Œç¨‹', mapLink: '#' }]
                    });
                }
                
                // å‰é€²ä¸€å¤© (24å°æ™‚çš„æ¯«ç§’æ•¸)
                currentDate = new Date(currentDate.getTime() + (24 * 60 * 60 * 1000));
            }

            return allDays;
        };

        // Mock data for initial setup
        const MOCK_WEATHER = {
            '03/21': { icon: 'ri-sun-line', color: 'orange', temp: '16Â°/9Â°C', feels: 14, desc: 'æ™´æœ—ï¼Œå¾®é¢¨' },
            '03/22': { icon: 'ri-cloudy-line', color: 'gray', temp: '15Â°/9Â°C', feels: 13, desc: 'å¤šé›²' },
            '03/23': { icon: 'ri-showers-line', color: '#6fa8dc', temp: '14Â°/11Â°C', feels: 12, desc: 'æœ‰é›¨ï¼Œè¨˜å¾—æ”œå¸¶é›¨å…·' },
            '03/24': { icon: 'ri-sun-cloudy-line', color: 'orange', temp: '18Â°/12Â°C', feels: 16, desc: 'å¤šé›²è½‰æ™´' },
            '03/25': { icon: 'ri-sun-cloudy-line', color: 'orange', temp: '22Â°/15Â°C', feels: 20, desc: 'æ™´æœ—èˆ’é©' },
            '03/26': { icon: 'ri-cloudy-line', color: 'gray', temp: '17Â°/10Â°C', feels: 15, desc: 'å¤šé›²' },
            '03/27': { icon: 'ri-sun-line', color: 'orange', temp: '19Â°/12Â°C', feels: 18, desc: 'æ™´æœ—' },
            '03/28': { icon: 'ri-sun-line', color: 'orange', temp: '20Â°/11Â°C', feels: 19, desc: 'F1 å¥½å¤©æ°£ (å…­)' },
            '03/29': { icon: 'ri-sun-line', color: 'orange', temp: '21Â°/12Â°C', feels: 20, desc: 'F1 æ±ºè³½æ—¥ (æ—¥)' },
            '04/04': { icon: 'ri-cloudy-line', color: 'gray', temp: '18Â°/14Â°C', feels: 17, desc: 'é™°å¤©' }
        };

        const MOCK_EXCHANGE_RATE = 0.22; // 1 JPY = 0.22 TWD

        // --- æ“´å……å¾Œçš„è©³ç´°è¡Œç¨‹è³‡æ–™ (3/21 - 4/04) ---
        const BASE_ITINERARY = [
            // Day 1: 03/21 (Sat) - æ±äº¬ ç§‹è‘‰åŸ
            {
                date: '03/21', dayOfWeek: 'Sat', location: 'æ±äº¬ Akihabara',
                weather: MOCK_WEATHER['03/21'],
                spots: [
                    // ç¢ºä¿èˆªç­è³‡è¨Šæ­£ç¢º
                    { id: 101, type: 'flight', category: 'èˆªç­', time: '10:55', name: 'JL802 æ¡ƒåœ’å‡ºç™¼', desc: '14:55æŠµé”NRTã€‚', flightNum: 'JL802', flightTime: '3h0m', mapLink: 'https://maps.app.goo.gl/N9sU1pY5e9yLzQ8q8' },
                    { id: 102, type: 'hotel', category: 'ä½å®¿', time: '17:00', name: 'ç§‹è‘‰åŸé›·å§†é£¯åº— Check-in', notes: 'é£¯åº—ç›´çµJRè»Šç«™ã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/C2qDqRz3v5G7L7kXA',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 103, type: 'shop', category: 'è³¼ç‰©', time: '17:30', name: 'ç§‹è‘‰åŸå‹•æ¼«æŒ–å¯¶', notes: 'æ‰‹è¾¦ã€é›»ç©ã€å‹•æ¼«å‘¨é‚Šã€‚', openHours: '10:00-21:00', mapLink: 'https://maps.app.goo.gl/3yGjFfM3X5HjQ8s18',
                      transport: { type: 'walk', time: '5m' } },
                    { id: 104, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šç§‹è‘‰åŸç«™å‘¨é‚Š', notes: 'ç‰¹è‰²æ‹‰éºµæˆ–å±…é…’å±‹ã€‚', openHours: '19:00-23:00', mapLink: 'https://maps.app.goo.gl/C2qDqRz3v5G7L7kXA',
                      transport: { type: 'walk', time: '10m' } }
                ]
            },
            // Day 2: 03/22 (Sun) - æ±äº¬ ç¯‰åœ°/å¹•å¼µ/éŒ¦ç³¸ç”º
            {
                date: '03/22', dayOfWeek: 'Sun', location: 'æ±äº¬ ç¯‰åœ°/å¹•å¼µ/éŒ¦ç³¸ç”º',
                weather: MOCK_WEATHER['03/22'],
                spots: [
                    { id: 201, type: 'food', category: 'ç¾é£Ÿ', time: '09:00', name: 'ç¯‰åœ°å ´å¤–å¸‚å ´', notes: 'æ—©åˆé¤ï¼Œåƒåƒå–å–æµ·é®®ä¸¼ã€‚', openHours: '09:00-14:00', mapLink: 'https://maps.app.goo.gl/x2Kz4bJ7J7L7kX',
                      transport: { type: 'train', time: '30m' } }, 
                    { id: 202, type: 'activity', category: 'æ™¯é»', time: '11:30', name: 'PokÃ©mon feat. åˆéŸ³æœªä¾†VOLTAGE Live! (é–‹å ´)', notes: 'LaLa arena TOKYO-BAYï¼Œé è¨ˆ12:00é–‹å§‹ã€‚', openHours: '11:00-15:00', ticket: 'é–€ç¥¨å·²è³¼', mapLink: 'https://maps.app.goo.gl/T4fG5Rz3v5G7L7kX',
                      transport: { type: 'train', time: '50m' } }, 
                    { id: 203, type: 'shop', category: 'è³¼ç‰©', time: '15:30', name: 'Lalaport ç”¨é¤èˆ‡é€›è¡—', notes: 'æ¼”å”±æœƒå¾Œåœ¨è³¼ç‰©ä¸­å¿ƒé€›é€›ã€‚', openHours: '10:00-21:00', mapLink: 'https://maps.app.goo.gl/T4fG5Rz3v5G7L7kX',
                      transport: { type: 'walk', time: '5m' } },
                    { id: 204, type: 'activity', category: 'æ™¯é»', time: '18:00', name: 'ğŸŒ¸éŒ¦ç³¸å…¬åœ’è³æ«»', notes: 'æ«»èŠ±+æ±äº¬æ™´ç©ºå¡”èƒŒæ™¯ã€‚', ticket: 'å…è²»', mapLink: 'https://maps.app.goo.gl/H5gH6Y7tD8F8N9a8',
                      transport: { type: 'train', time: '40m' } }, 
                    { id: 205, type: 'activity', category: 'æ™¯é»', time: '19:00', name: 'æ±Ÿæˆ¶ NOREN', notes: 'æ„Ÿå—æ±Ÿæˆ¶é¢¨æƒ…èˆ‡ç´€å¿µå“ã€‚', mapLink: 'https://maps.app.goo.gl/Y4cI5E8rF7L7kX',
                      transport: { type: 'train', time: '5m' } }, 
                    { id: 206, type: 'food', category: 'ç¾é£Ÿ', time: '20:30', name: 'æ™šé¤ï¼šç‚¸è±¬æ’/ç›¸æ’²é‹', notes: 'ã¨ã‚“ã‹ã¤ ã¯ã›å· æˆ– éœ§å³¶ç›¸æ’²é‹ã€‚', openHours: '20:30-22:00', mapLink: 'https://maps.app.goo.gl/Y4cI5E8rF7L7kX',
                      transport: { type: 'walk', time: '5m' } },
                    { id: 207, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'ç§‹è‘‰åŸé›·å§†é£¯åº—', notes: 'é€£ä½ç¬¬äºŒæ™šã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/C2qDqRz3v5G7L7kXA',
                      transport: { type: 'train', time: '15m' } } 
                ]
            },
            // Day 3: 03/23 (Mon) - æ±äº¬è¿ªå£«å°¼æ¨‚åœ’
            {
                date: '03/23', dayOfWeek: 'Mon', location: 'æ±äº¬è¿ªå£«å°¼æ¨‚åœ’',
                weather: MOCK_WEATHER['03/23'],
                spots: [
                    { id: 301, type: 'shop', category: 'è³¼ç‰©', time: '12:00', name: 'ä¼Šå…‹æ–¯çš®å…’è‰è³¼ç‰©ä¸­å¿ƒ', notes: 'åˆé¤èˆ‡é€›è¡—ã€‚', openHours: '10:00-21:00', mapLink: 'https://maps.app.goo.gl/X2yD2zC7F8K9M0p7',
                      transport: { type: 'train', time: '40m' } }, 
                    { id: 302, type: 'activity', category: 'æ™¯é»', time: '14:00', name: 'æ±äº¬è¿ªå£«å°¼æ¨‚åœ’', notes: 'ç°¡å–®ç©ç©ï¼Œçœ‹ç…™ç«ã€‚', openHours: '08:00-21:00', ticket: 'é–€ç¥¨å·²è³¼', mapLink: 'https://maps.app.goo.gl/X2yD2zC7F8K9M0p7',
                      transport: { type: 'walk', time: '10m' } },
                    { id: 303, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'æ±äº¬è¿ªå£«å°¼æµ·æ´‹å¤¢å¹»æ³‰é„‰å¤§é£¯åº—', notes: 'å¤¢å¹»é¤¨ï¼Œéš”æ—¥éŠç© Seaã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/Z2uA7C8qR0W9T1kZ',
                      transport: { type: 'walk', time: '15m' } } 
                ]
            },
            // Day 4: 03/24 (Tue) - æ±äº¬è¿ªå£«å°¼æµ·æ´‹
            {
                date: '03/24', dayOfWeek: 'Tue', location: 'æ±äº¬è¿ªå£«å°¼æµ·æ´‹',
                weather: MOCK_WEATHER['03/24'],
                spots: [
                    { id: 401, type: 'activity', category: 'æ™¯é»', time: '09:00', name: 'æ•´å¤©éŠç© DisneySea', notes: 'åˆ©ç”¨å¿«é€Ÿé€šé—œï¼Œç©è½‰åœ°ä¸­æµ·æ¸¯ç£ã€‚', openHours: '08:00-21:00', ticket: 'é–€ç¥¨å·²è³¼', mapLink: 'https://maps.app.goo.gl/A1tS2D3eF4G5H6i7',
                      transport: { type: 'walk', time: '5m' } }, 
                    { id: 402, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'æ±äº¬ç£å¤§å€‰é…’åº— Check-in', notes: 'å«éš”æ—¥æ—©é¤ã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/B2uV3W4xY5Z6A7b8',
                      transport: { type: 'car', time: '15m' } } 
                ]
            },
            // Day 5: 03/25 (Wed) - ç§»å‹•æ—¥ & åå¤å±‹æ•£ç­–
            {
                date: '03/25', dayOfWeek: 'Wed', location: 'åå¤å±‹',
                weather: MOCK_WEATHER['03/25'],
                spots: [
                    { id: 501, type: 'other', category: 'äº¤é€š', time: '09:30', name: 'æ–°å¹¹ç·šå‰å¾€åå¤å±‹', notes: 'å¾èˆæ¿±ç«™/æ±äº¬ç«™æ­ä¹˜æ–°å¹¹ç·š (ç´„2hrs)ã€‚', openHours: 'N/A', mapLink: 'https://maps.app.goo.gl/C3vW4X5yZ6A7B8c9',
                      transport: { type: 'train', time: '30m' } }, 
                    { id: 502, type: 'hotel', category: 'ä½å®¿', time: '12:00', name: 'åå¤å±‹ä¸‰äº•èŠ±åœ’é£¯åº— Check-in', notes: 'å…ˆæ”¾è¡Œæï¼Œå†å‡ºç™¼ã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/D4xY5Z6aB7C8D9e0',
                      transport: { type: 'train', time: '10m' } }, 
                    { id: 503, type: 'activity', category: 'æ™¯é»', time: '14:30', name: 'ğŸŒ¸å±±å´å· å››å­£ä¹‹é“ (æ•£æ­¥)', notes: 'å»ºè­°èµ°ã€ŒçŸ³å·æ©‹ã€œæ–°ç‘æ©‹ã€è³æ«»ã€‚', ticket: 'å…è²»', mapLink: 'https://maps.app.goo.gl/E5yZ6A7bC8D9E0f1',
                      transport: { type: 'train', time: '30m' } }, 
                    { id: 504, type: 'activity', category: 'æ™¯é»', time: '16:00', name: 'ä¸‰è¼ªç¥ç¤¾', notes: 'ç‰¹è‰²å…”å­ç±¤è©©ã€‚', mapLink: 'https://maps.app.goo.gl/F6zB7C8dA9E0F1g2',
                      transport: { type: 'walk', time: '15m' } },
                    { id: 505, type: 'shop', category: 'è³¼ç‰©', time: '17:00', name: 'å¤§é ˆå•†åº—è¡—æ•£ç­–', notes: 'è¬æ¾å¯ºé€šã€æœ¬ç”ºé€šã€èµ¤é–€é€šã€‚', openHours: '10:00-20:00', mapLink: 'https://maps.app.goo.gl/G7aC8D9eF0G1H2i3',
                      transport: { type: 'train', time: '20m' } }, 
                    { id: 506, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šå¤§é ˆå‘¨é‚Šç‰¹è‰²æ–™ç†', notes: 'å¦‚å°ç£æ‹‰éºµæˆ–ç•¶åœ°å±…é…’å±‹ã€‚', openHours: '20:00-22:00', mapLink: 'https://maps.app.goo.gl/G7aC8D9eF0G1H2i3',
                      transport: { type: 'walk', time: '10m' } },
                    { id: 507, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'åå¤å±‹ä¸‰äº•èŠ±åœ’é£¯åº—', notes: 'é€£ä½ç¬¬äºŒæ™šã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/D4xY5Z6aB7C8D9e0',
                      transport: { type: 'train', time: '15m' } }
                ]
            },
            // Day 6: 03/26 (Thu) - F1 éˆ´é¹¿è³½é“ï¼ˆåˆæ¬¡æ¢è¨ªï¼‰
            {
                date: '03/26', dayOfWeek: 'Thu', location: 'F1 éˆ´é¹¿è³½é“',
                weather: MOCK_WEATHER['03/26'],
                spots: [
                    { id: 601, type: 'activity', category: 'æ™¯é»', time: '13:00', name: 'F1 éˆ´é¹¿è³½é“ (åˆå¾Œ)', notes: 'ç†Ÿæ‚‰ç’°å¢ƒèˆ‡å‘¨é‚Šæ´»å‹•ã€‚', openHours: '10:00-17:00', ticket: 'N/A', mapLink: 'https://maps.app.goo.gl/H8bE0F1gG2H3I4j5',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 602, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šåå¤å±‹ç«™å‘¨é‚Š', notes: 'å›è»Šç«™é™„è¿‘ç”¨é¤ã€‚', openHours: '20:00-22:00', mapLink: 'https://maps.app.goo.gl/J1cM4N5oP6Q7R8s9',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 603, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'åå¤å±‹ä¸‰äº•èŠ±åœ’é£¯åº—', notes: 'é€£ä½ç¬¬ä¸‰æ™šã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/D4xY5Z6aB7C8D9e0',
                      transport: { type: 'walk', time: '5m' } }
                ]
            },
            // Day 7: 03/27 (Fri) - åå¤å±‹å¸‚å€è§€å…‰
            {
                date: '03/27', dayOfWeek: 'Fri', location: 'åå¤å±‹å¸‚å€',
                weather: MOCK_WEATHER['03/27'],
                spots: [
                    { id: 701, type: 'hotel', category: 'ä½å®¿', time: '09:00', name: 'å…ˆå°‡è¡Œæç§»è‡³ APA é£¯åº—', notes: 'å…ˆ Check-in æˆ–å¯„æ”¾è¡Œæã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/K2dN5P6qR7S8T9u0',
                      transport: { type: 'walk', time: '10m' } }, 
                    { id: 702, type: 'activity', category: 'æ™¯é»', time: '10:30', name: 'åå¤å±‹åŸ', notes: 'åƒè§€æœ¬ä¸¸å¾¡æ®¿ã€‚', openHours: '09:00-16:30', ticket: 'Â¥500', mapLink: 'https://maps.app.goo.gl/L3eQ6R7sT8U9V0w1',
                      transport: { type: 'train', time: '15m' } }, 
                    { id: 703, type: 'activity', category: 'æ™¯é»', time: '13:00', name: 'ç¶ æ´² 21', notes: 'æ°´ä¹‹å®‡å®™èˆ¹æ‹ç…§ã€‚', mapLink: 'https://maps.app.goo.gl/M4fR7S8tU9V0W1x2',
                      transport: { type: 'train', time: '10m' } }, 
                    { id: 704, type: 'activity', category: 'æ™¯é»', time: '14:00', name: 'ä¸­éƒ¨é›»åŠ› MIRAI TOWER', notes: 'åœ¨ç¶ æ´² 21 æ‹å¡”ã€‚', mapLink: 'https://maps.app.goo.gl/M4fR7S8tU9V0W1x2',
                      transport: { type: 'walk', time: '5m' } },
                    { id: 705, type: 'food', category: 'ç¾é£Ÿ', time: '15:00', name: 'åˆé¤ï¼šé°»é­šé£¯ (æ¦®ç”º)', notes: 'ç†±ç”°è“¬èŠè»’æˆ–å…¶ä»–ã€‚', openHours: '11:00-14:30', mapLink: 'https://maps.app.goo.gl/N5gS8T9uV0W1X2y3',
                      transport: { type: 'walk', time: '10m' } },
                    { id: 706, type: 'shop', category: 'è³¼ç‰©', time: '17:00', name: 'æ¦®ç”ºé€›è¡— & åå¤å±‹PARCO', notes: 'ç™¾è²¨å…¬å¸è³¼ç‰©ã€‚', openHours: '10:00-20:00', mapLink: 'https://maps.app.goo.gl/P7iV0W1xY2Z3A4b5',
                      transport: { type: 'walk', time: '10m' } },
                    { id: 707, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šçŸ¢å ´å‘³å™Œè±¬æ’', notes: 'åå¤å±‹ç‰¹è‰²æ–™ç†ã€‚', openHours: '20:00-22:00', mapLink: 'https://maps.app.goo.gl/Q8jW1X2yZ3A4B5c6',
                      transport: { type: 'train', time: '15m' } },
                    { id: 708, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'åå¤å±‹ç«™å‰APAé£¯åº—', notes: 'F1 æœŸé–“ä½å®¿ã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/K2dN5P6qR7S8T9u0',
                      transport: { type: 'train', time: '10m' } } 
                ]
            },
            // Day 8: 03/28 (Sat) - F1 éˆ´é¹¿è³½é“ï¼ˆæ’ä½è³½/è¡åˆºè³½ï¼‰
            {
                date: '03/28', dayOfWeek: 'Sat', location: 'F1 éˆ´é¹¿è³½é“',
                weather: MOCK_WEATHER['03/28'],
                spots: [
                    { id: 801, type: 'activity', category: 'æ™¯é»', time: '09:00', name: 'F1 éˆ´é¹¿è³½é“ (æ’ä½è³½/è¡åˆºè³½)', notes: 'æ•´å¤©è§€è³½ï¼Œè«‹æ³¨æ„é˜²æ›¬ã€‚', openHours: '08:00-18:00', ticket: 'é–€ç¥¨å·²è³¼', mapLink: 'https://maps.app.goo.gl/H8bE0F1gG2H3I4j5',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 802, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šè³½é“æˆ–åå¤å±‹ç«™å‘¨é‚Š', notes: 'å¯èƒ½åœ¨è»Šç«™å…§ç°¡å–®ç”¨é¤ã€‚', openHours: '20:00-22:00', mapLink: 'https://maps.app.goo.gl/R9kX2Y3zZ4A5B6d7',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 803, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'åå¤å±‹ç«™å‰APAé£¯åº—', notes: 'é€£ä½ç¬¬äºŒæ™šã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/K2dN5P6qR7S8T9u0',
                      transport: { type: 'walk', time: '5m' } }
                ]
            },
            // Day 9: 03/29 (Sun) - F1 éˆ´é¹¿è³½é“ï¼ˆæ±ºè³½ï¼‰
            {
                date: '03/29', dayOfWeek: 'Sun', location: 'F1 éˆ´é¹¿è³½é“',
                weather: MOCK_WEATHER['03/29'],
                spots: [
                    { id: 901, type: 'activity', category: 'æ™¯é»', time: '09:00', name: 'F1 éˆ´é¹¿è³½é“ (æ±ºè³½)', notes: 'æœ€é‡è¦çš„æ±ºè³½æ—¥ï¼', openHours: '08:00-18:00', ticket: 'é–€ç¥¨å·²è³¼', mapLink: 'https://maps.app.goo.gl/H8bE0F1gG2H3I4j5',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 902, type: 'food', category: 'ç¾é£Ÿ', time: '20:00', name: 'æ™šé¤ï¼šæ…¶åŠŸå®´', notes: 'æ…¶ç¥æ¯”è³½é †åˆ©çµæŸã€‚', openHours: '20:00-22:00', mapLink: 'https://maps.app.goo.gl/S0lY3Z4aB5C6D7e8',
                      transport: { type: 'train', time: '1h20m' } }, 
                    { id: 903, type: 'hotel', category: 'ä½å®¿', time: '22:00', name: 'åå¤å±‹ç«™å‰APAé£¯åº—', notes: 'é€£ä½ç¬¬ä¸‰æ™šã€‚', openHours: '24H', mapLink: 'https://maps.app.goo.gl/K2dN5P6qR7S8T9u0',
                      transport: { type: 'walk', time: '5m' } }
                ]
            },
            // Day 15: 04/04 (Sat) - å›ç¨‹
            {
                date: '04/04', dayOfWeek: 'Sat', location: 'æ±äº¬ç¾½ç”° HND',
                weather: MOCK_WEATHER['04/04'],
                spots: [
                     { id: 401, type: 'activity', category: 'äº¤é€š', time: '15:00', name: 'å‰å¾€ç¾½ç”°æ©Ÿå ´', notes: 'å¾å¤§é–€ç«™å‰å¾€ HNDã€‚', mapLink: 'https://maps.app.goo.gl/T1mZ4A5bC6D7E8f9',
                      transport: { type: 'train', time: '40m' } },
                    // ç¢ºä¿èˆªç­è³‡è¨Šæ­£ç¢º
                    { id: 402, type: 'flight', category: 'èˆªç­', time: '18:20', name: 'JL099 ç¾½ç”°å‡ºç™¼', desc: '20:40æŠµé”TSAã€‚', flightNum: 'JL099', flightTime: '2h20m', mapLink: 'https://maps.app.goo.gl/U2nA5B6cD7E8F9g0',
                      transport: { type: 'train', time: '15m' } }
                ]
            }
        ];
        // --- End of BASE_ITINERARY ---

        createApp({
            components: { Draggable },
            setup() {
                const currentTopTab = ref('itinerary');
                const currentDay = ref(0);
                const filterType = ref('');

                // Modals State
                const isSpotModalOpen = ref(false);
                const isDeleteConfirmOpen = ref(false);
                const isExpenseModalOpen = ref(false);
                const isShopModalOpen = ref(false);
                const activeSpot = ref({});
                const activeSpotIndex = ref(null);
                const isEditingSpot = computed(() => activeSpotIndex.value !== null);
                const spotModalTitle = computed(() => isEditingSpot.value ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹');
                const activeExpense = ref({});
                const activeShopItem = ref({});

                const topTabs = [
                    { id: 'itinerary', icon: 'ri-map-pin-time-line' },
                    { id: 'info', icon: 'ri-information-line' },
                    { id: 'shopping', icon: 'ri-shopping-basket-line' },
                    { id: 'expense', icon: 'ri-money-cny-box-line' }
                ];

                const itineraryCategories = [
                    { value: 'activity', label: 'æ™¯é»' },
                    { value: 'hotel', label: 'ä½å®¿' },
                    { value: 'food', label: 'ç¾é£Ÿ' },
                    { value: 'shop', label: 'è³¼ç‰©' },
                    { value: 'flight', label: 'èˆªç­' },
                    { value: 'other', label: 'å…¶ä»–' }
                ];
                
                // ç”Ÿæˆ 15 å¤©çš„å®Œæ•´è¡Œç¨‹è³‡æ–™ (03/21 - 04/04)
                const itineraryData = ref(generateItineraryDays('03/21', '04/04', BASE_ITINERARY));

                // --- Helper Functions ---
                const getCategoryLabel = (type) => itineraryCategories.find(c => c.value === type)?.label || 'å…¶ä»–';
                
                const getTransportIcon = (type) => {
                    if (type === 'walk') return 'ri-walk-line';
                    if (type === 'car') return 'ri-car-line';
                    if (type === 'train') return 'ri-train-line'; // Used for all public transit
                    return 'ri-time-line';
                };

                const filterSpot = (type) => {
                    return filterType.value === '' || filterType.value === type;
                };
                
                // --- Info Data ---
                const exchangeRate = ref({ jpyToTwd: MOCK_EXCHANGE_RATE });
                const jpyInput = ref(1000);
                const convertedTwd = computed(() => (jpyInput.value * exchangeRate.value.jpyToTwd).toFixed(0).toLocaleString('en-US'));

                // *** èˆªç­è³‡è¨Š (èˆ‡ç”¨æˆ¶æä¾›çš„ä¸€è‡´) ***
                const flightInfo = ref([
                    { type: 'departure', date: '03/21', time: '10:55', arrivalTime: '14:55', from: 'TPE æ¡ƒåœ’åœ‹éš›æ©Ÿå ´T2', to: 'NRT æˆç”°æ©Ÿå ´T2', flight: 'JL802', class: 'ç¶“æ¿Ÿè‰™S', flightTime: '3h0m' },
                    { type: 'return', date: '04/04', time: '18:20', arrivalTime: '20:40', from: 'HND æ±äº¬ç¾½ç”°æ©Ÿå ´T3', to: 'TSA æ¾å±±æ©Ÿå ´T1', flight: 'JL099', class: 'ç¶“æ¿Ÿè‰™S', flightTime: '2h20m' }
                ]);
                
                const locationInfo = ref([
                    { category: 'ä½å®¿', name: 'ç§‹è‘‰åŸé›·å§†é£¯åº—', phone: '+81 3-3253-1212', address: 'ã€’101-0025 æ±äº¬éƒ½åƒä»£ç”°åŒºç¥ç”°ä½ä¹…é–“ç”º1-6-5', mapLink: 'https://maps.app.goo.gl/C2qDqRz3v5G7L7kXA' },
                    { category: 'ä½å®¿', name: 'æ±äº¬ç£å¤§å€‰é…’åº—', phone: '+81 47-355-3333', address: 'ã€’279-8585 åƒè‘‰çœŒæµ¦å®‰å¸‚èˆæµœ1-8', mapLink: 'https://maps.app.goo.gl/B2uV3W4xY5Z6A7b8' },
                    { category: 'ä½å®¿', name: 'åå¤å±‹ä¸‰äº•èŠ±åœ’é£¯åº—', phone: '+81 52-446-0111', address: 'ã€’450-0002 æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…4ä¸ç›®11âˆ’27', mapLink: 'https://maps.app.goo.gl/D4xY5Z6aB7C8D9e0' },
                    { category: 'ä½å®¿', name: 'åå¤å±‹ç«™å‰APAé£¯åº—', phone: '+81 52-588-3011', address: 'ã€’450-0002 æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…3ä¸ç›®25-11', mapLink: 'https://maps.app.goo.gl/K2dN5P6qR7S8T9u0' }
                ]);

                // --- Shopping & Expense Data/Methods ---
                const shoppingList = ref([
                    // status: 'pending' (æœªè³¼è²·) æˆ– 'bought' (å·²è³¼è²·)
                    { name: 'F1 éˆ´é¹¿é™å®š T-shirt', imageUrl: null, status: 'pending', id: 1 },
                    { name: 'åŒ—æµ·é“ ç™½è‰²æˆ€äºº', imageUrl: 'https://via.placeholder.com/64/FF9EAA/FFFFFF?text=WL', status: 'bought', id: 2 },
                    { name: 'æ±äº¬å·´å¥ˆå¥ˆ', imageUrl: null, status: 'pending', id: 3 },
                    { name: 'åˆéŸ³æ¼”å”±æœƒç´€å¿µå“', imageUrl: 'https://via.placeholder.com/64/77DD77/FFFFFF?text=MIKU', status: 'pending', id: 4 }
                ]);

                const expenseCategories = ['äº¤é€š', 'é£²é£Ÿ', 'ä½å®¿', 'é–€ç¥¨', 'è³¼ç‰©', 'å…¶ä»–'];
                const expenseList = ref([
                    { id: 501, category: 'äº¤é€š', name: 'NEX è»Šç¥¨', date: '2026-03-21', amount: 3500, payment: 'ä¿¡ç”¨å¡', notes: 'å–®ç¨‹' },
                    { id: 502, category: 'é£²é£Ÿ', name: 'æ™šé¤ æ‹‰éºµ', date: '2026-03-21', amount: 1200, payment: 'ç¾é‡‘', notes: '' },
                    { id: 503, category: 'ä½å®¿', name: 'ç§‹è‘‰åŸé›·å§†é£¯åº—', date: '2026-03-21', amount: 25000, payment: 'ä¿¡ç”¨å¡', notes: '2æ™š' }
                ]);
                const totalExpense = computed(() => expenseList.value.reduce((sum, item) => sum + item.amount, 0));

                // NEW FUNCTION: Toggle Shopping Status
                const toggleShopStatus = (index) => {
                    const item = shoppingList.value[index];
                    item.status = item.status === 'pending' ? 'bought' : 'pending';
                };


                // --- Spot Methods ---
                const openSpotAdd = () => {
                    activeSpot.value = { id: Date.now(), type: 'activity', name: '', time: '', openHours: '', ticket: '', notes: '', mapLink: 'https://maps.app.goo.gl/add_link', transport: { type: 'train', time: '10m' } };
                    activeSpotIndex.value = null;
                    isSpotModalOpen.value = true;
                };

                const openSpotEdit = (index) => {
                    activeSpot.value = JSON.parse(JSON.stringify(itineraryData.value[currentDay.value].spots[index]));
                    activeSpotIndex.value = index;
                    isSpotModalOpen.value = true;
                };

                const saveSpot = () => {
                    const spots = itineraryData.value[currentDay.value].spots;
                    if (isEditingSpot.value) {
                        spots[activeSpotIndex.value] = activeSpot.value;
                    } else {
                        if (spots.length === 1 && spots[0].type === 'empty') {
                             spots.splice(0, 1);
                        }
                        spots.push(activeSpot.value);
                    }
                    isSpotModalOpen.value = false;
                };

                const confirmDeleteSpot = () => {
                    isSpotModalOpen.value = false;
                    isDeleteConfirmOpen.value = true;
                };

                const deleteSpot = () => {
                    itineraryData.value[currentDay.value].spots.splice(activeSpotIndex.value, 1);
                    if (itineraryData.value[currentDay.value].spots.length === 0) {
                         itineraryData.value[currentDay.value].spots.push({ id: Date.now() + Math.random(), type: 'empty', name: 'é»æ“Šæ–°å¢ä»Šæ—¥è¡Œç¨‹', mapLink: '#' });
                    }
                    isDeleteConfirmOpen.value = false;
                    activeSpotIndex.value = null;
                };
                
                // --- Expense Methods ---
                const toggleExpenseModal = (mode, item = {}, index = null) => {
                    if (mode === 'add') {
                        // é è¨­æ—¥æœŸä½¿ç”¨ 2026/03/21
                        activeExpense.value = { id: Date.now(), category: '', name: '', date: '2026-03-21', amount: null, payment: 'ç¾é‡‘', notes: '' };
                    } else {
                        activeExpense.value = JSON.parse(JSON.stringify(item));
                        activeExpense.value.index = index;
                    }
                    isExpenseModalOpen.value = true;
                };

                const saveExpense = () => {
                    if (activeExpense.value.index !== undefined) {
                        expenseList.value[activeExpense.value.index] = activeExpense.value;
                    } else {
                        expenseList.value.push(activeExpense.value);
                    }
                    isExpenseModalOpen.value = false;
                };

                // --- Shop Methods ---
                const toggleShopModal = (mode, item = {}, index = null) => {
                    if (mode === 'add') {
                        activeShopItem.value = { name: '', imageUrl: null, status: 'pending', id: Date.now() }; // Default to pending
                    } else {
                        activeShopItem.value = JSON.parse(JSON.stringify(item));
                        activeShopItem.value.index = index;
                    }
                    spotModalTitle.value = mode === 'add' ? 'æ–°å¢è³¼ç‰©æ¸…å–®' : 'ç·¨è¼¯è³¼ç‰©æ¸…å–®';
                    isShopModalOpen.value = true;
                };

                const saveShopItem = () => {
                    if (activeShopItem.value.index !== undefined) {
                        const idx = activeShopItem.value.index;
                        shoppingList.value[idx].name = activeShopItem.value.name;
                        shoppingList.value[idx].imageUrl = activeShopItem.value.imageUrl;
                        // Status is maintained unless edited manually
                    } else {
                        shoppingList.value.push(activeShopItem.value);
                    }
                    isShopModalOpen.value = false;
                };

                const handleImageUpload = (event) => {
                    // This simulates image upload in a browser environment
                    activeShopItem.value.imageUrl = 'https://via.placeholder.com/64/FF9EAA/FFFFFF?text=UPLOADED';
                    alert('åœ–ç‰‡å·²æ¨¡æ“¬ä¸Šå‚³ï¼');
                };

                return {
                    currentTopTab, topTabs, currentDay, itineraryData, getCategoryLabel, getTransportIcon,
                    filterType, filterSpot, itineraryCategories, isSpotModalOpen, openSpotAdd, openSpotEdit,
                    saveSpot, activeSpot, isEditingSpot, spotModalTitle, isDeleteConfirmOpen, confirmDeleteSpot,
                    deleteSpot, exchangeRate, jpyInput, convertedTwd, flightInfo, locationInfo, shoppingList,
                    isShopModalOpen, toggleShopModal, activeShopItem, saveShopItem, handleImageUpload, toggleShopStatus,
                    expenseCategories, expenseList, totalExpense, isExpenseModalOpen, toggleExpenseModal,
                    activeExpense, saveExpense
                };
            }
        }).mount('#app');
    </script>
</body>
</html>