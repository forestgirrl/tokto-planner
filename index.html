<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日本F1櫻花自由行 2026</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            light: '#FFF0F5', 
                            DEFAULT: '#FFB7C5', 
                            dark: '#FF8FAB', 
                        },
                        warm: {
                            bg: '#FDFBF9',
                            text: '#595048',
                            grey: '#E5E0DD'
                        },
                        tag: {
                            eat: '#FF9F43',   
                            buy: '#9C88FF',   
                            photo: '#0ABDE3', 
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(255, 183, 197, 0.2)',
                        'card': '0 2px 8px rgba(0,0,0,0.05)',
                        'float': '0 8px 30px rgba(0,0,0,0.12)',
                        'nav': '0 -4px 20px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FDFBF9;
            color: #595048;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: constant(safe-area-inset-bottom); /* iOS 11.0 */
            padding-bottom: env(safe-area-inset-bottom); /* iOS 11.2+ */
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Main Layout */
        .content-wrapper {
            margin-top: -24px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            background-color: #FDFBF9;
            position: relative;
            z-index: 10;
            padding-top: 24px;
            min-height: calc(100vh - 220px);
            /* Increase padding bottom to accommodate fixed nav bar */
            padding-bottom: 120px; 
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: repeating-linear-gradient(to bottom, #E5E0DD 0, #E5E0DD 6px, transparent 6px, transparent 12px);
            z-index: 0;
        }
        
        /* Animation */
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .weather-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }

        /* Bottom Nav Safe Area */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>

<div id="app" class="flex flex-col min-h-screen">

    <header class="relative w-full h-[250px] flex-shrink-0">
        <div class="w-full h-full overflow-hidden bg-gray-200">
            <img src="f1cat.png" 
                 onerror="this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=1920&auto=format&fit=crop'" 
                 alt="Header" 
                 class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent"></div>
        </div>

        <div class="absolute bottom-10 right-6 text-white drop-shadow-md text-right">
            <p class="text-[10px] font-bold tracking-[0.2em] opacity-90 mb-1">JAPAN 2026</p>
            <h1 class="text-2xl font-black tracking-widest">F1 櫻花自由行</h1>
        </div>
    </header>

    <main class="content-wrapper px-4">
        
        <div v-if="currentTab === 'itinerary'" class="animate-slide-up">
            
            <div class="flex overflow-x-auto hide-scrollbar gap-3 mb-6 pb-2 sticky top-0 bg-warm-bg/95 backdrop-blur-md z-30 py-2 -mx-4 px-4 border-b border-gray-100/50">
                <div v-for="(day, index) in days" :key="index" 
                     @click="selectDay(index)"
                     :class="['flex-shrink-0 flex flex-col items-center justify-center w-[4.5rem] h-20 rounded-2xl transition-all duration-300 border-2 snap-center cursor-pointer', 
                              selectedDayIndex === index ? 'bg-sakura text-white border-sakura shadow-soft transform scale-105' : 'bg-white text-warm-text border-transparent shadow-sm']">
                    <span class="text-[10px] font-bold uppercase tracking-wider opacity-80">{{ day.weekday }}</span>
                    <span class="text-2xl font-black">{{ day.dateParts.day }}</span>
                    <span class="text-[10px] opacity-60">{{ day.dateParts.month }}月</span>
                </div>
            </div>

            <div class="relative bg-white rounded-3xl p-5 mb-8 shadow-card overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 text-gray-400 text-xs font-bold mb-2">
                            <i class="fa-solid fa-location-dot text-sakura"></i>
                            {{ weather.location }}
                        </div>
                        <div class="flex items-center gap-3">
                            <i :class="[weather.icon, weather.color]" class="text-4xl weather-float"></i>
                            <div class="leading-none">
                                <span class="text-4xl font-black text-gray-700 tracking-tighter">{{ weather.temp }}°</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2 ml-1">體感 {{ weather.feelsLike }}° · {{ weather.desc }}</div>
                    </div>
                    <div class="text-right space-y-1">
                        <div class="bg-sakura/10 text-sakura-dark px-3 py-1 rounded-full text-xs font-bold">
                            降雨 10%
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative min-h-[300px]">
                <div class="timeline-line"></div>

                <div v-if="currentDayItinerary.length === 0" class="text-center py-16 text-gray-300 relative z-10">
                    <i class="fa-solid fa-mug-hot text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm">本日尚無行程</p>
                </div>

                <div class="space-y-6">
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative pl-14 group">
                        
                        <div class="absolute left-0 top-0 w-12 flex flex-col items-center z-10">
                            <div class="text-xs font-bold text-gray-400 mb-1 font-mono">{{ item.time }}</div>
                            <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-sm shadow-md border-[3px] border-warm-bg" :class="getCategoryBg(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div v-if="index < currentDayItinerary.length - 1 || item.travelTime" 
                                 class="mt-2 bg-white border border-gray-100 shadow-sm text-[10px] text-gray-400 px-2 py-0.5 rounded-full flex flex-col items-center gap-0.5">
                                <i :class="item.transportType === 'walk' ? 'fa-solid fa-person-walking' : 'fa-solid fa-train-subway'"></i>
                                <span>{{ item.travelTime || '15m' }}</span>
                            </div>
                        </div>

                        <div @click="openGoogleMaps(item.location)" class="bg-white rounded-2xl p-4 shadow-card active:scale-[0.98] transition-transform duration-200 border border-transparent hover:border-sakura/30 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-gray-400 bg-gray-50 px-2 py-1 rounded-md">
                                    {{ getCategoryLabel(item.category) }}
                                </span>
                                <div class="flex gap-1">
                                    <span v-for="tag in item.tags" :key="tag" 
                                          :class="['text-[10px] px-2 py-0.5 rounded-full font-bold', getTagStyle(tag)]">
                                        {{ getTagLabel(tag) }}
                                    </span>
                                </div>
                            </div>

                            <h3 class="font-bold text-lg text-gray-800 leading-tight mb-1">{{ item.name }}</h3>
                            <p v-if="item.desc" class="text-xs text-gray-500 leading-relaxed mb-3 line-clamp-2">{{ item.desc }}</p>

                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-50">
                                <div class="text-xs text-gray-400 flex gap-3">
                                    <span v-if="item.cost"><i class="fa-solid fa-yen-sign mr-1"></i>{{ item.cost }}</span>
                                </div>
                                <button class="bg-blue-50 text-blue-500 px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-location-arrow"></i> 導航
                                </button>
                            </div>
                            <button @click.stop="editItem(item)" class="absolute top-2 right-2 p-2 text-gray-300 hover:text-gray-500">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="openAddModal('itinerary')" class="fixed bottom-24 right-5 w-14 h-14 bg-sakura text-white rounded-full shadow-float flex items-center justify-center text-2xl z-40 transition-transform active:scale-90 border-2 border-white">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'map'" class="animate-slide-up">
            <h2 class="text-xl font-bold mb-4 text-gray-800 pl-2 border-l-4 border-sakura">行程地圖</h2>
            <div class="h-[70vh] bg-gray-100 rounded-2xl overflow-hidden shadow-inner relative">
                <iframe width="100%" height="100%" style="border:0" loading="lazy" allowfullscreen src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3240.828030772665!2d139.76454987679632!3d35.68123617258707!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x60188bfbd89f700b%3A0x277c49ba34ed38!2z5p2x5Lqs6LuK!5e0!3m2!1szh-TW!2stw!4v1709624584223!5m2!1szh-TW!2stw"></iframe>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-slide-up">
            <div class="bg-gradient-to-br from-sakura to-sakura-dark text-white rounded-2xl p-6 mb-6 shadow-lg relative overflow-hidden">
                <p class="text-sm opacity-90 mb-1">總支出 (TWD)</p>
                <h2 class="text-4xl font-black tracking-tight">NT$ {{ totalExpenseTWD.toLocaleString() }}</h2>
                <div class="mt-4 flex gap-4 text-xs opacity-80 font-medium">
                    <span class="bg-white/20 px-2 py-1 rounded"><i class="fa-solid fa-money-bill-wave mr-1"></i>現金: {{ expenseStats.cash }}%</span>
                    <span class="bg-white/20 px-2 py-1 rounded"><i class="fa-regular fa-credit-card mr-1"></i>卡片: {{ expenseStats.card }}%</span>
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-3 px-1">支出紀錄</h3>
            <div class="space-y-3">
                <div v-for="expense in expenses" :key="expense.id" class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between border border-gray-50">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 text-lg">
                            <i :class="getExpenseIcon(expense.category)"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-700 text-sm">{{ expense.name }}</div>
                            <div class="text-[10px] text-gray-400">{{ expense.date }} · {{ expense.payment }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-800">¥{{ expense.amount.toLocaleString() }}</div>
                        <div class="text-[10px] text-gray-400">≈ NT${{ Math.round(expense.amount * 0.215).toLocaleString() }}</div>
                    </div>
                </div>
            </div>
            <button @click="openAddModal('expense')" class="fixed bottom-24 right-5 w-14 h-14 bg-yellow-400 text-white rounded-full shadow-float flex items-center justify-center text-2xl z-40 transition-transform active:scale-90 border-2 border-white">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'shopping'" class="animate-slide-up">
            <h2 class="text-xl font-bold mb-4 text-gray-800 pl-2 border-l-4 border-purple-400">購物清單</h2>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="item in shoppingList" :key="item.id" class="bg-white rounded-xl overflow-hidden shadow-card group relative">
                    <div class="h-32 bg-gray-100 relative overflow-hidden">
                        <div v-if="!item.image" class="w-full h-full flex items-center justify-center text-gray-300">
                            <i class="fa-solid fa-image text-2xl opacity-50"></i>
                        </div>
                        <img v-else :src="item.image" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2">
                             <input type="checkbox" v-model="item.bought" class="w-6 h-6 accent-purple-500 rounded-full cursor-pointer shadow-sm">
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-gray-800 text-sm truncate" :class="{'line-through text-gray-400': item.bought}">{{ item.name }}</h3>
                        <p class="text-xs text-gray-400 mt-1">預算: ¥{{ item.price }}</p>
                    </div>
                </div>
            </div>
            <button @click="openAddModal('shopping')" class="fixed bottom-24 right-5 w-14 h-14 bg-purple-400 text-white rounded-full shadow-float flex items-center justify-center text-2xl z-40 transition-transform active:scale-90 border-2 border-white">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'info'" class="animate-slide-up space-y-6">
            <div class="bg-white p-5 rounded-2xl shadow-card border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-3 text-sm"><i class="fa-solid fa-calculator mr-2 text-sakura"></i>匯率換算 (0.215)</h3>
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-gray-50 rounded-xl p-2 px-3">
                        <label class="block text-[10px] text-gray-400 mb-1">JPY</label>
                        <input type="number" v-model="calcJPY" class="w-full bg-transparent font-mono text-xl font-bold text-gray-700 outline-none">
                    </div>
                    <i class="fa-solid fa-arrow-right text-gray-300"></i>
                    <div class="flex-1 bg-gray-50 rounded-xl p-2 px-3">
                        <label class="block text-[10px] text-gray-400 mb-1">TWD</label>
                        <div class="w-full font-mono text-xl font-bold text-sakura-dark">{{ calculatedTWD }}</div>
                    </div>
                </div>
            </div>
             <div class="space-y-3">
                 <h3 class="font-bold text-gray-800 pl-2 border-l-4 border-blue-400">航班</h3>
                 <div class="bg-white p-4 rounded-xl shadow-card flex justify-between items-center">
                     <div>
                         <div class="text-xs text-blue-500 font-bold mb-1">JL802 (TPE-NRT)</div>
                         <div class="font-black text-lg text-gray-700">10:55 - 14:55</div>
                     </div>
                     <i class="fa-solid fa-plane text-blue-100 text-2xl"></i>
                 </div>
             </div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-100 shadow-nav z-50 pb-safe">
        <div class="flex justify-around items-center h-[60px]">
            <div v-for="tab in tabs" :key="tab.id" 
                 @click="currentTab = tab.id" 
                 class="flex-1 flex flex-col items-center justify-center gap-1 h-full cursor-pointer transition-colors duration-200"
                 :class="currentTab === tab.id ? 'text-sakura' : 'text-gray-400'">
                <i :class="tab.icon" class="text-lg mb-0.5"></i>
                <span class="text-[10px] font-medium">{{ tab.label }}</span>
            </div>
        </div>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-black/40 backdrop-blur-sm p-4" @click.self="closeModal">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up pb-8 max-h-[85vh] overflow-y-auto">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div v-if="modalType === 'itinerary'">
                <h3 class="text-xl font-bold mb-6 text-center text-gray-700">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-1">分類</label>
                        <div class="flex gap-2 overflow-x-auto py-2 no-scrollbar">
                            <button v-for="cat in categories" :key="cat.value" @click="form.category = cat.value"
                                    :class="['flex-shrink-0 px-3 py-2 rounded-xl text-xs font-bold border', form.category === cat.value ? 'bg-sakura text-white border-sakura' : 'bg-white text-gray-500 border-gray-200']">
                                <i :class="cat.icon" class="mr-1"></i> {{ cat.label }}
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <input v-model="form.time" type="time" class="w-1/3 bg-gray-50 border border-gray-100 p-3 rounded-xl outline-none">
                        <input v-model="form.name" type="text" placeholder="名稱" class="w-2/3 bg-gray-50 border border-gray-100 p-3 rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-1">標籤</label>
                        <div class="flex gap-2 mt-1">
                            <button v-for="(cfg, key) in tagConfig" :key="key" @click="toggleTag(key)"
                                    :class="['px-3 py-1 rounded-lg text-xs font-bold border', form.tags.includes(key) ? cfg.activeClass : 'bg-white text-gray-400 border-gray-200']">
                                {{ cfg.label }}
                            </button>
                        </div>
                    </div>
                    <textarea v-model="form.desc" rows="2" placeholder="備註..." class="w-full bg-gray-50 border border-gray-100 p-3 rounded-xl outline-none"></textarea>
                    <input v-model="form.location" type="text" placeholder="Google Maps 關鍵字" class="w-full bg-gray-50 border border-gray-100 p-3 rounded-xl outline-none">
                </div>
            </div>

            <div v-if="modalType === 'expense'">
                <h3 class="text-xl font-bold mb-6 text-center text-gray-700">新增支出</h3>
                <div class="space-y-4">
                    <input v-model="expenseForm.name" placeholder="項目名稱" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none">
                    <input v-model="expenseForm.amount" type="number" placeholder="金額 (JPY)" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none font-mono">
                    <div class="flex gap-3">
                         <select v-model="expenseForm.category" class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none">
                             <option value="food">飲食</option>
                             <option value="transport">交通</option>
                             <option value="shopping">購物</option>
                             <option value="hotel">住宿</option>
                             <option value="other">其他</option>
                         </select>
                         <select v-model="expenseForm.payment" class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none">
                             <option value="現金">現金</option>
                             <option value="信用卡">信用卡</option>
                         </select>
                    </div>
                </div>
            </div>

            <div v-if="modalType === 'shopping'">
                <h3 class="text-xl font-bold mb-6 text-center text-gray-700">新增購物清單</h3>
                <div class="space-y-4">
                    <input v-model="shoppingForm.name" placeholder="商品名稱" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none">
                    <input v-model="shoppingForm.price" type="number" placeholder="預算金額 (JPY)" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none">
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button v-if="isEditing && modalType === 'itinerary'" @click="deleteItem" class="flex-1 bg-red-50 text-red-400 py-3 rounded-2xl font-bold text-sm">刪除</button>
                <button @click="saveModalData" class="flex-[2] bg-sakura text-white py-3 rounded-2xl font-bold text-sm shadow-lg shadow-pink-200">
                    確認儲存
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'itinerary',
                // Tabs Config Updated with Labels
                tabs: [
                    { id: 'itinerary', label: '行程', icon: 'fa-solid fa-route' },
                    { id: 'map', label: '地圖', icon: 'fa-solid fa-map-location-dot' },
                    { id: 'expenses', label: '花費', icon: 'fa-solid fa-yen-sign' },
                    { id: 'shopping', label: '購物', icon: 'fa-solid fa-basket-shopping' },
                    { id: 'info', label: '資訊', icon: 'fa-solid fa-circle-info' },
                ],
                
                selectedDayIndex: 0,
                days: [],
                itineraryData: {},
                weather: { icon: 'fa-solid fa-sun', color: 'text-orange-400', temp: 18, feelsLike: 16, desc: '晴朗', location: '東京' },

                showModal: false,
                modalType: 'itinerary', 
                isEditing: false,
                editingId: null,
                
                form: { category: 'attraction', name: '', time: '', desc: '', location: '', tags: [], transportType: 'train' },
                expenseForm: { name: '', amount: '', category: 'food', payment: '現金' },
                shoppingForm: { name: '', price: '', bought: false },

                categories: [
                    { label: '景點', value: 'attraction', icon: 'fa-camera' },
                    { label: '美食', value: 'food', icon: 'fa-utensils' },
                    { label: '購物', value: 'shopping', icon: 'fa-bag-shopping' },
                    { label: '住宿', value: 'hotel', icon: 'fa-bed' },
                    { label: '交通', value: 'transport', icon: 'fa-train' }
                ],
                tagConfig: {
                    'must-eat': { label: '必吃', activeClass: 'bg-orange-100 text-tag-eat border-orange-200' },
                    'must-buy': { label: '必買', activeClass: 'bg-purple-100 text-tag-buy border-purple-200' },
                    'must-photo': { label: '必拍', activeClass: 'bg-cyan-100 text-tag-photo border-cyan-200' }
                },

                expenses: [
                    { id: 1, name: '午餐', amount: 1500, category: 'food', payment: '現金', date: '03/21' },
                    { id: 2, name: 'Suica 儲值', amount: 3000, category: 'transport', payment: '現金', date: '03/21' }
                ],
                shoppingList: [
                    { id: 1, name: '藥妝店採購', price: 10000, bought: false, image: null },
                    { id: 2, name: 'F1 官方周邊', price: 15000, bought: false, image: null }
                ],
                calcJPY: 1000
            }
        },
        computed: {
            currentDateKey() { return this.days[this.selectedDayIndex]?.fullDate; },
            currentDayItinerary() {
                const list = this.itineraryData[this.currentDateKey] || [];
                return list.sort((a, b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
            },
            totalExpenseTWD() { return Math.round(this.expenses.reduce((sum, item) => sum + item.amount, 0) * 0.215); },
            expenseStats() {
                const total = this.expenses.length;
                if(total === 0) return { cash: 0, card: 0 };
                const cash = this.expenses.filter(e => e.payment === '現金').length;
                const cashPct = Math.round((cash/total)*100);
                return { cash: cashPct, card: 100 - cashPct };
            },
            calculatedTWD() { return Math.round(this.calcJPY * 0.215).toLocaleString(); }
        },
        mounted() {
            this.generateDays();
            this.initData();
        },
        methods: {
            generateDays() {
                const start = new Date('2026-03-21');
                const end = new Date('2026-04-04');
                const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                let current = start;
                while (current <= end) {
                    const month = current.getMonth() + 1;
                    const date = current.getDate();
                    const fullDateStr = `2026-${String(month).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                    this.days.push({
                        weekday: dayNames[current.getDay()],
                        dateParts: { month, day: date },
                        fullDate: fullDateStr
                    });
                    current.setDate(current.getDate() + 1);
                }
            },
            initData() {
                this.itineraryData['2026-03-21'] = [
                    { id: 1, category: 'transport', time: '10:55', name: '抵達東京', desc: 'JL802 TPE -> NRT', location: 'Narita Airport', tags: [], transportType: 'train' },
                    { id: 2, category: 'hotel', time: '16:00', name: 'Check-in', desc: '秋葉原雷姆飯店', location: 'Remm Akihabara', tags: [], transportType: 'train' }
                ];
                this.itineraryData['2026-03-25'] = [
                     { id: 3, category: 'transport', time: '09:40', name: '新幹線 -> 名古屋', desc: 'Hikari 號', location: 'Nagoya Station', tags: [], transportType: 'train' },
                     { id: 4, category: 'food', time: '12:00', name: '矢場味噌豬排', desc: '名古屋必吃美食', location: 'Yabaton', tags: ['must-eat'], transportType: 'walk' }
                ];
            },
            selectDay(index) { this.selectedDayIndex = index; },
            getCategoryBg(cat) {
                const map = { attraction: 'bg-sakura', food: 'bg-orange-400', shopping: 'bg-purple-400', transport: 'bg-blue-400', hotel: 'bg-indigo-400' };
                return map[cat] || 'bg-gray-400';
            },
            getCategoryIcon(cat) { return this.categories.find(c => c.value === cat)?.icon || 'fa-circle'; },
            getCategoryLabel(cat) { return this.categories.find(c => c.value === cat)?.label || cat; },
            getTagStyle(tagKey) { return this.tagConfig[tagKey]?.activeClass || ''; },
            getTagLabel(tagKey) { return this.tagConfig[tagKey]?.label || ''; },
            getExpenseIcon(cat) { const map = { food: 'fa-utensils', transport: 'fa-train', shopping: 'fa-bag-shopping', hotel: 'fa-bed', other: 'fa-yen-sign' }; return `fa-solid ${map[cat]}`; },
            openGoogleMaps(location) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location || 'Japan')}`, '_blank'); },
            openAddModal(type) {
                this.modalType = type;
                this.isEditing = false;
                if(type === 'itinerary') this.form = { category: 'attraction', name: '', time: '', desc: '', location: '', tags: [], transportType: 'train' };
                if(type === 'expense') this.expenseForm = { name: '', amount: '', category: 'food', payment: '現金' };
                if(type === 'shopping') this.shoppingForm = { name: '', price: '', bought: false };
                this.showModal = true;
            },
            editItem(item) {
                this.modalType = 'itinerary';
                this.isEditing = true;
                this.editingId = item.id;
                this.form = JSON.parse(JSON.stringify(item));
                if(!this.form.tags) this.form.tags = [];
                this.showModal = true;
            },
            toggleTag(key) {
                const idx = this.form.tags.indexOf(key);
                if(idx === -1) this.form.tags.push(key);
                else this.form.tags.splice(idx, 1);
            },
            saveModalData() {
                if(this.modalType === 'itinerary') {
                    const list = this.itineraryData[this.currentDateKey] || [];
                    if (this.isEditing) {
                        const idx = list.findIndex(x => x.id === this.editingId);
                        if(idx !== -1) list[idx] = { ...this.form, id: this.editingId };
                    } else {
                        if(!this.itineraryData[this.currentDateKey]) this.itineraryData[this.currentDateKey] = [];
                        this.itineraryData[this.currentDateKey].push({ ...this.form, id: Date.now() });
                    }
                }
                else if(this.modalType === 'expense') {
                    this.expenses.unshift({ id: Date.now(), ...this.expenseForm, date: this.days[this.selectedDayIndex].dateParts.month + '/' + this.days[this.selectedDayIndex].dateParts.day });
                }
                else if(this.modalType === 'shopping') {
                    this.shoppingList.push({ id: Date.now(), ...this.shoppingForm });
                }
                this.closeModal();
            },
            deleteItem() {
                if(confirm('確定刪除?')) {
                    const list = this.itineraryData[this.currentDateKey];
                    const idx = list.findIndex(x => x.id === this.editingId);
                    if(idx !== -1) list.splice(idx, 1);
                    this.closeModal();
                }
            },
            closeModal() { this.showModal = false; }
        }
    }).mount('#app');
</script>
</body>
</html>
