<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sakura F1 Trip 2026</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF8BA0',      /* 更鮮豔的櫻花粉 */
                        secondary: '#FFF0F5',    /* 極淺粉 */
                        accent: '#FF5C77',       /* 強調色 */
                        bg: '#FFFAFB',           /* 背景色 */
                        textMain: '#4A4A4A',
                        textLight: '#8C8C8C',
                        glass: 'rgba(255, 255, 255, 0.85)'
                    },
                    fontFamily: {
                        zen: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'float': '0 10px 30px -10px rgba(255, 139, 160, 0.4)',
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(255, 255, 255, 0.5)'
                    },
                    animation: {
                        'bounce-slight': 'bounce-slight 0.3s ease-in-out',
                    },
                    keyframes: {
                        'bounce-slight': {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.97)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* APP 質感優化 CSS */
        body {
            background-color: #FFFAFB;
            /* 防止手機下拉重整，更像 Native App */
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 隱藏捲軸但保持滾動 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 轉場動畫 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease, transform 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(10px); }
        
        /* 拖曳時的效果 */
        .ghost { opacity: 0.6; background: #FFF0F5; border: 2px dashed #FF8BA0; }
        
        /* 毛玻璃特效 */
        .backdrop-blur-md { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-bg text-textMain font-zen antialiased min-h-screen lg:max-w-[430px] lg:mx-auto lg:border-x lg:border-gray-100 lg:shadow-2xl relative pb-24">

    <div id="app">
        
        <header class="relative w-full h-[280px] rounded-b-[40px] overflow-hidden shadow-lg z-10">
            <img src="https://images.unsplash.com/photo-1490750967868-53cb0505672c?q=80&w=2070&auto=format&fit=crop" alt="Sakura" class="w-full h-full object-cover">
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent flex flex-col justify-end p-6">
                <div class="text-white"> 
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-primary/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold shadow-sm">15 Days</span>
                        <span class="text-sm font-medium opacity-90 tracking-wide">2026.03.21 - 04.04</span> 
                    </div>
                    <h1 class="text-3xl font-black tracking-wide drop-shadow-lg">日本 F1 櫻花行</h1>
                    <p class="text-white/80 text-sm mt-1 flex items-center gap-1"><i class="ri-map-pin-line"></i> 東京・名古屋・鈴鹿</p>
                </div>
            </div>
        </header>

        <div class="sticky top-4 z-40 px-4 mt-[-30px]">
            <div class="bg-white/90 backdrop-blur-md p-1.5 rounded-2xl shadow-float flex justify-between items-center border border-white/40">
                <button v-for="tab in topTabs" :key="tab.id" @click="currentTopTab = tab.id"
                        class="flex-1 py-3 rounded-xl flex items-center justify-center transition-all duration-300 relative overflow-hidden"
                        :class="currentTopTab === tab.id ? 'text-white shadow-md bg-primary' : 'text-gray-400 hover:bg-gray-50'">
                    <i :class="tab.icon" class="text-xl relative z-10"></i>
                    <span class="text-xs font-bold ml-1 relative z-10" v-if="currentTopTab === tab.id">{{ tab.name }}</span>
                </button>
            </div>
        </div>

        <main class="mt-6 px-5 space-y-6">
            
            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'itinerary'" key="itinerary">
                    
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 -mx-5 px-5 snap-x">
                        <div v-for="(day, index) in itineraryData" :key="index" 
                             @click="currentDay = index"
                             class="flex-shrink-0 snap-center flex flex-col items-center justify-center w-[64px] h-[80px] rounded-2xl border transition-all duration-300 cursor-pointer"
                             :class="currentDay === index ? 'bg-primary border-primary text-white shadow-lg scale-105' : 'bg-white border-transparent text-gray-400 shadow-sm'">
                            <span class="text-xs font-medium uppercase tracking-wider opacity-80">{{ day.dayOfWeek }}</span>
                            <span class="text-2xl font-black">{{ day.date.split('/')[1] }}</span>
                        </div>
                    </div>

                    <div class="mt-4 bg-white/60 p-5 rounded-3xl border border-white shadow-card backdrop-blur-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-black text-gray-700">{{ itineraryData[currentDay].location }}</h2>
                            <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded-lg">{{ itineraryData[currentDay].date }}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-2xl" :style="{ color: itineraryData[currentDay].weather.color }">
                                <i :class="itineraryData[currentDay].weather.icon"></i>
                            </div>
                            <div>
                                <p class="font-bold text-lg text-gray-700">{{ itineraryData[currentDay].weather.temp }}</p>
                                <p class="text-xs text-gray-500">{{ itineraryData[currentDay].weather.desc }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                         <div class="flex justify-between items-center mb-4">
                             <h3 class="font-bold text-lg text-gray-700">今日行程</h3>
                             <select v-model="filterType" class="bg-white border-none text-sm font-bold text-gray-500 py-1 pl-2 pr-6 rounded-lg shadow-sm focus:ring-0">
                                <option value="">全部顯示</option>
                                <option v-for="cat in itineraryCategories" :value="cat.value">{{ cat.label }}</option>
                             </select>
                        </div>
                        
                        <draggable v-model="itineraryData[currentDay].spots" item-key="id" tag="div" 
                                   handle=".drag-handle" :animation="250" ghost-class="ghost" class="space-y-4">
                            <template #item="{ element: spot, index: idx }">
                                <div v-show="filterSpot(spot.type)">
                                    
                                    <div v-if="spot.transport && spot.transport.time" class="flex items-center justify-center mb-4 opacity-60">
                                        <div class="text-[10px] font-bold text-gray-400 px-3 py-1 rounded-full bg-white border border-gray-100 flex items-center gap-1 shadow-sm">
                                            <i :class="getTransportIcon(spot.transport.type)"></i>
                                            <span>約 {{ spot.transport.time }}</span>
                                        </div>
                                    </div>
                                    
                                    <div @click="spot.type === 'empty' ? openSpotAdd() : openSpotEdit(idx)"
                                         class="relative bg-white p-5 rounded-3xl shadow-card active:scale-[0.98] transition-transform duration-200 border border-gray-50 overflow-hidden group">
                                         
                                        <div class="absolute left-0 top-0 bottom-0 w-[6px]" 
                                             :class="{
                                                'bg-tagFood': spot.type === 'food',
                                                'bg-tagShop': spot.type === 'shop',
                                                'bg-tagPic': spot.type === 'pic',
                                                'bg-primary': ['activity', 'hotel', 'flight', 'other'].includes(spot.type),
                                                'bg-gray-200': spot.type === 'empty'
                                             }"></div>

                                        <div v-if="spot.type !== 'empty'">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white"
                                                            :class="{
                                                                'bg-tagFood': spot.type === 'food',
                                                                'bg-tagShop': spot.type === 'shop',
                                                                'bg-tagPic': spot.type === 'pic',
                                                                'bg-primary': ['activity', 'hotel', 'flight', 'other'].includes(spot.type)
                                                            }">
                                                            {{ getCategoryLabel(spot.type) }}
                                                        </span>
                                                        <span class="text-xs font-bold text-gray-400 font-mono">{{ spot.time }}</span>
                                                    </div>
                                                    <h3 class="text-lg font-bold text-gray-800 leading-tight">{{ spot.name }}</h3>
                                                </div>
                                                
                                                <div class="flex flex-col items-center gap-3 pl-2">
                                                    <i class="ri-draggable text-gray-300 drag-handle cursor-move text-xl"></i>
                                                    <a :href="getGoogleMapLink(spot)" target="_blank" @click.stop class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center shadow-sm hover:bg-blue-500 hover:text-white transition-colors">
                                                        <i class="ri-navigation-fill text-lg"></i>
                                                    </a>
                                                </div>
                                            </div>

                                            <div class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-500 space-y-1">
                                                <p v-if="spot.openHours" class="flex items-center gap-2"><i class="ri-time-line text-xs"></i> {{ spot.openHours }}</p>
                                                <p v-if="spot.ticket" class="flex items-center gap-2"><i class="ri-ticket-line text-xs"></i> {{ spot.ticket }}</p>
                                                <p v-if="spot.notes" class="text-gray-600 italic bg-gray-50 p-2 rounded-lg mt-2">{{ spot.notes }}</p>
                                                <div v-if="spot.type === 'flight'" class="bg-gray-800 text-white p-3 rounded-xl mt-2 text-xs">
                                                    <div class="flex justify-between">
                                                        <span>{{ spot.flightNum }}</span>
                                                        <span>{{ spot.flightTime }}</span>
                                                    </div>
                                                    <div class="mt-1 opacity-80">{{ spot.desc }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div v-else class="text-center py-4 text-gray-400">
                                            <i class="ri-add-circle-fill text-4xl text-gray-200 mb-2 block"></i>
                                            <span class="text-sm font-bold">點擊新增行程</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </draggable>
                        
                        <div class="h-24"></div> <button @click="openSpotAdd" class="fixed bottom-6 right-6 w-14 h-14 bg-black text-white rounded-full shadow-2xl z-40 flex items-center justify-center hover:scale-110 active:scale-90 transition-transform">
                            <i class="ri-add-line text-2xl"></i>
                        </button>
                    </div>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'info'" key="info" class="space-y-6 pb-20">
                    
                    <section class="bg-white rounded-3xl p-6 shadow-card">
                        <h2 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">匯率換算</h2>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                                <input v-model.number="jpyInput" type="number" class="w-full text-2xl font-black text-gray-800 border-b-2 border-gray-100 focus:border-primary outline-none py-1 bg-transparent" placeholder="0">
                            </div>
                            <i class="ri-arrow-right-line text-xl text-gray-300"></i>
                            <div class="flex-1 text-right">
                                <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                                <div class="text-2xl font-black text-primary">{{ convertedTwd }}</div>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-center">參考匯率: {{ exchangeRate.jpyToTwd }}</p>
                    </section>

                    <section>
                         <h2 class="text-lg font-bold text-gray-800 mb-3 px-2">我的航班</h2>
                         <div class="space-y-3">
                             <div v-for="flight in flightInfo" :key="flight.flight" class="bg-white p-5 rounded-3xl shadow-card relative overflow-hidden">
                                 <div class="absolute top-0 right-0 bg-primary text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl">
                                     {{ flight.type === 'departure' ? '去程' : '回程' }}
                                 </div>
                                 <div class="flex justify-between items-end mb-4">
                                     <div>
                                         <div class="text-3xl font-black text-gray-800">{{ flight.from.split(' ')[0] }}</div>
                                         <div class="text-xs text-gray-500">{{ flight.time }}</div>
                                     </div>
                                     <i class="ri-plane-fill text-2xl text-gray-200 rotate-90"></i>
                                     <div class="text-right">
                                         <div class="text-3xl font-black text-gray-800">{{ flight.to.split(' ')[0] }}</div>
                                         <div class="text-xs text-gray-500">{{ flight.arrivalTime }}</div>
                                     </div>
                                 </div>
                                 <div class="border-t border-gray-100 pt-3 flex justify-between text-xs text-gray-500 font-bold">
                                     <span>{{ flight.date }}</span>
                                     <span>{{ flight.flight }}</span>
                                     <span>{{ flight.flightTime }}</span>
                                 </div>
                             </div>
                         </div>
                    </section>

                    <section>
                        <h2 class="text-lg font-bold text-gray-800 mb-3 px-2">住宿資訊</h2>
                        <div class="space-y-3">
                            <div v-for="item in locationInfo" :key="item.name" class="bg-white p-4 rounded-2xl shadow-card flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                                    <p class="text-xs text-gray-500 mt-1 line-clamp-1 w-48">{{ item.address }}</p>
                                </div>
                                <a :href="getGoogleMapLink({name: item.name, location: item.address, mapLink: item.mapLink})" target="_blank" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-primary hover:bg-primary hover:text-white transition">
                                    <i class="ri-map-pin-2-fill"></i>
                                </a>
                            </div>
                        </div>
                    </section>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'shopping'" key="shopping" class="pb-24">
                     <div class="flex justify-between items-center mb-4 px-2">
                        <h2 class="text-xl font-bold">必買清單</h2>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded-lg text-gray-500">{{ shoppingList.filter(i => i.status === 'bought').length }} / {{ shoppingList.length }} 完成</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="(item, idx) in shoppingList" :key="idx" 
                             class="bg-white p-3 rounded-2xl shadow-card flex flex-col justify-between transition-all"
                             :class="{'opacity-50 grayscale': item.status === 'bought'}">
                            
                            <div class="aspect-square bg-gray-50 rounded-xl mb-3 overflow-hidden relative">
                                <img v-if="item.imageUrl" :src="item.imageUrl" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full flex items-center justify-center text-gray-200">
                                    <i class="ri-shopping-bag-3-line text-3xl"></i>
                                </div>
                                <button @click="toggleShopStatus(idx)" class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-md transition-colors"
                                    :class="item.status === 'bought' ? 'bg-green-500 text-white' : 'bg-white text-gray-300'">
                                    <i class="ri-check-line text-lg"></i>
                                </button>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-sm leading-tight mb-1">{{ item.name }}</h4>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-[10px] text-gray-400">{{ item.status === 'bought' ? '已購' : '未購' }}</span>
                                    <button @click="toggleShopModal('edit', item, idx)" class="text-gray-400 hover:text-primary"><i class="ri-pencil-fill"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button @click="toggleShopModal('add')" class="fixed bottom-6 right-6 w-14 h-14 bg-black text-white rounded-full shadow-2xl z-40 flex items-center justify-center hover:scale-110 active:scale-90 transition-transform">
                        <i class="ri-add-line text-2xl"></i>
                    </button>
                </div>
            </transition>

            <transition name="fade" mode="out-in">
                <div v-if="currentTopTab === 'expense'" key="expense" class="pb-24">
                    <div class="bg-gradient-to-br from-gray-800 to-black text-white rounded-3xl p-6 shadow-xl mb-6 relative overflow-hidden">
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                        <p class="text-sm font-medium text-gray-400">總支出</p>
                        <div class="flex items-baseline gap-2 mt-1">
                            <span class="text-4xl font-black">¥ {{ totalExpense.toLocaleString('en-US') }}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 border-t border-white/20 pt-2">約合 NT$ {{ (totalExpense * exchangeRate.jpyToTwd).toFixed(0).toLocaleString('en-US') }}</p>
                    </div>

                    <div class="bg-white rounded-3xl shadow-card overflow-hidden">
                        <div v-for="(item, idx) in expenseList" :key="idx" 
                             @click="toggleExpenseModal('edit', item, idx)"
                             class="p-4 border-b border-gray-50 last:border-0 flex justify-between items-center active:bg-gray-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-secondary text-primary flex items-center justify-center text-lg">
                                    <i :class="getExpenseIcon(item.category)"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                                    <p class="text-xs text-gray-400">{{ item.date }} · {{ item.payment }}</p>
                                </div>
                            </div>
                            <span class="font-bold text-lg text-gray-800">-{{ item.amount.toLocaleString() }}</span>
                        </div>
                    </div>

                    <button @click="toggleExpenseModal('add')" class="fixed bottom-6 right-6 w-14 h-14 bg-black text-white rounded-full shadow-2xl z-40 flex items-center justify-center hover:scale-110 active:scale-90 transition-transform">
                        <i class="ri-add-line text-2xl"></i>
                    </button>
                </div>
            </transition>

        </main>

        <div v-if="isSpotModalOpen" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="isSpotModalOpen = false">
            <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-bounce-slight pb-10 sm:pb-6">
                <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div> <h3 class="text-xl font-black text-gray-800 mb-4">{{ spotModalTitle }}</h3>
                <form @submit.prevent="saveSpot" class="space-y-3">
                    <input v-model="activeSpot.name" type="text" placeholder="行程名稱 *" required class="w-full p-3 bg-gray-50 rounded-xl font-bold outline-none focus:ring-2 focus:ring-primary/50">
                    <div class="flex gap-3">
                         <select v-model="activeSpot.type" class="flex-1 p-3 bg-gray-50 rounded-xl font-bold outline-none text-gray-600">
                            <option v-for="cat in itineraryCategories" :value="cat.value">{{ cat.label }}</option>
                        </select>
                        <input v-model="activeSpot.time" type="time" class="w-32 p-3 bg-gray-50 rounded-xl font-bold outline-none text-center">
                    </div>
                    <input v-model="activeSpot.notes" placeholder="備註..." class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none">
                    
                    <div class="flex gap-3 mt-4 pt-2">
                        <button v-if="isEditingSpot" @click.prevent="confirmDeleteSpot" type="button" class="flex-1 py-3 bg-red-50 text-red-500 rounded-xl font-bold"><i class="ri-delete-bin-line"></i></button>
                        <button type="submit" class="flex-[3] py-3 bg-black text-white rounded-xl font-bold shadow-lg active:scale-95 transition">儲存</button>
                    </div>
                </form>
            </div>
        </div>

        <div v-if="isExpenseModalOpen" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="isExpenseModalOpen = false">
            <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl pb-10 sm:pb-6">
                <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>
                <h3 class="text-xl font-black mb-4">記帳</h3>
                <form @submit.prevent="saveExpense" class="space-y-3">
                    <div class="flex gap-2 mb-2">
                        <button type="button" v-for="cat in expenseCategories" 
                            @click="activeExpense.category = cat"
                            class="px-3 py-1 rounded-full text-xs font-bold transition-colors"
                            :class="activeExpense.category === cat ? 'bg-primary text-white' : 'bg-gray-100 text-gray-400'">
                            {{ cat }}
                        </button>
                    </div>
                    <input v-model="activeExpense.name" placeholder="項目名稱" required class="w-full p-3 bg-gray-50 rounded-xl font-bold outline-none">
                    <input v-model="activeExpense.amount" type="number" placeholder="¥ 金額" required class="w-full p-3 bg-gray-50 rounded-xl font-bold outline-none text-xl">
                    <button type="submit" class="w-full py-3 bg-black text-white rounded-xl font-bold mt-4 shadow-lg">儲存</button>
                </form>
            </div>
        </div>

        <div v-if="isDeleteConfirmOpen" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5">
            <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl transform scale-100">
                <h4 class="font-bold text-lg mb-2 text-gray-800">確定刪除嗎？</h4>
                <div class="flex gap-3 mt-4">
                    <button @click="isDeleteConfirmOpen = false" class="flex-1 py-2 rounded-xl bg-gray-100 font-bold text-gray-500">取消</button>
                    <button @click="deleteSpot" class="flex-1 py-2 rounded-xl bg-red-500 text-white font-bold shadow-lg">刪除</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed } = Vue;
        const Draggable = vuedraggable;

        // --- 資料設定 ---
        const MOCK_WEATHER = {
            '03/21': { icon: 'ri-sun-line', color: '#FDB813', temp: '16°', desc: '晴朗' },
            '03/22': { icon: 'ri-cloudy-line', color: '#A0A0A0', temp: '15°', desc: '多雲' },
            '03/23': { icon: 'ri-showers-line', color: '#6fa8dc', temp: '14°', desc: '有雨' },
            '03/24': { icon: 'ri-sun-cloudy-line', color: '#FDB813', temp: '18°', desc: '轉晴' },
            '03/25': { icon: 'ri-sun-line', color: '#FDB813', temp: '22°', desc: '舒適' },
            '03/26': { icon: 'ri-cloudy-line', color: '#A0A0A0', temp: '17°', desc: '陰天' },
            '03/27': { icon: 'ri-sun-line', color: '#FDB813', temp: '19°', desc: '晴朗' },
            '03/28': { icon: 'ri-fire-line', color: '#FF4500', temp: '20°', desc: 'F1!' },
            '03/29': { icon: 'ri-trophy-line', color: '#FFD700', temp: '21°', desc: '決賽' },
            '04/04': { icon: 'ri-plane-line', color: '#666', temp: '18°', desc: '回程' }
        };

        // 沿用你的原始資料 (簡化顯示)
        const BASE_ITINERARY = [
            { date: '03/21', dayOfWeek: 'Sat', location: '東京 秋葉原', weather: MOCK_WEATHER['03/21'], spots: [
                { id: 101, type: 'flight', category: '航班', time: '10:55', name: 'JL802 桃園 -> 成田', desc: 'T2 14:55抵達', flightNum: 'JL802', flightTime: '3h0m' },
                { id: 102, type: 'hotel', category: '住宿', time: '17:00', name: '秋葉原雷姆飯店', notes: '直結車站', openHours: '24H', transport: { type: 'train', time: '80m' } },
                { id: 103, type: 'shop', category: '購物', time: '18:00', name: '秋葉原動漫店', notes: 'Radio會館', openHours: '20:00', transport: { type: 'walk', time: '5m' } }
            ]},
            { date: '03/22', dayOfWeek: 'Sun', location: '東京 幕張', weather: MOCK_WEATHER['03/22'], spots: [
                { id: 201, type: 'food', category: '美食', time: '09:00', name: '築地場外市場', notes: '海鮮丼', transport: { type: 'train', time: '30m' } },
                { id: 202, type: 'activity', category: '景點', time: '12:00', name: '初音未來 Live!', notes: 'LaLa arena TOKYO-BAY', ticket: '已購票', transport: { type: 'train', time: '50m' } }
            ]},
            { date: '03/23', dayOfWeek: 'Mon', location: '迪士尼樂園', weather: MOCK_WEATHER['03/23'], spots: [
                 { id: 301, type: 'activity', time: '09:00', name: '東京迪士尼樂園', notes: '陸地整天', ticket: 'QR Code' }
            ]},
            { date: '03/24', dayOfWeek: 'Tue', location: '迪士尼海洋', weather: MOCK_WEATHER['03/24'], spots: [
                 { id: 401, type: 'activity', time: '09:00', name: '東京迪士尼海洋', notes: 'Fantasy Springs', ticket: 'QR Code' },
                 { id: 402, type: 'hotel', time: '21:00', name: '東京灣大倉酒店', notes: 'Check-in' }
            ]},
            { date: '03/25', dayOfWeek: 'Wed', location: '移動 -> 名古屋', weather: MOCK_WEATHER['03/25'], spots: [
                 { id: 501, type: 'other', time: '09:30', name: '新幹線 -> 名古屋', notes: 'Nozomi', transport: { type: 'train', time: '100m' } },
                 { id: 502, type: 'activity', time: '14:30', name: '山崎川賞櫻', notes: '四季之道', transport: { type: 'train', time: '30m' } }
            ]},
            { date: '03/26', dayOfWeek: 'Thu', location: '鈴鹿賽道', weather: MOCK_WEATHER['03/26'], spots: [
                 { id: 601, type: 'activity', time: '13:00', name: '鈴鹿賽道巡禮', notes: '熟悉環境', transport: { type: 'train', time: '80m' } }
            ]},
            { date: '03/27', dayOfWeek: 'Fri', location: '名古屋市區', weather: MOCK_WEATHER['03/27'], spots: [
                 { id: 701, type: 'activity', time: '10:00', name: '名古屋城', notes: '本丸御殿' },
                 { id: 702, type: 'food', time: '12:00', name: '蓬萊軒鰻魚飯', notes: '需排隊' }
            ]},
            { date: '03/28', dayOfWeek: 'Sat', location: 'F1 排位賽', weather: MOCK_WEATHER['03/28'], spots: [
                 { id: 801, type: 'activity', time: '09:00', name: 'F1 排位賽', notes: '鈴鹿賽道', ticket: 'V2席' }
            ]},
            { date: '03/29', dayOfWeek: 'Sun', location: 'F1 決賽', weather: MOCK_WEATHER['03/29'], spots: [
                 { id: 901, type: 'activity', time: '14:00', name: 'F1 正賽開始', notes: '鈴鹿賽道', ticket: 'V2席' }
            ]},
            { date: '04/04', dayOfWeek: 'Sat', location: '東京羽田', weather: MOCK_WEATHER['04/04'], spots: [
                 { id: 991, type: 'flight', time: '18:20', name: 'JL099 羽田 -> 松山', desc: 'TSA 20:40抵達', flightNum: 'JL099', flightTime: '2h20m' }
            ]}
        ];

        createApp({
            components: { Draggable },
            setup() {
                const currentTopTab = ref('itinerary');
                const currentDay = ref(0);
                const filterType = ref('');
                
                // Tabs
                const topTabs = [
                    { id: 'itinerary', icon: 'ri-calendar-event-line', name: '行程' },
                    { id: 'info', icon: 'ri-suitcase-2-line', name: '資訊' },
                    { id: 'shopping', icon: 'ri-shopping-bag-3-line', name: '必買' },
                    { id: 'expense', icon: 'ri-wallet-3-line', name: '記帳' }
                ];

                // Data logic
                const itineraryCategories = [
                    { value: 'activity', label: '景點', color: 'bg-primary' },
                    { value: 'food', label: '美食', color: 'bg-tagFood' },
                    { value: 'shop', label: '購物', color: 'bg-tagShop' },
                    { value: 'hotel', label: '住宿', color: 'bg-primary' },
                    { value: 'flight', label: '航班', color: 'bg-gray-600' }
                ];
                
                // 填充 15 天數據
                const generateDays = () => {
                    // 簡單處理，實際可用 Moment.js
                    return BASE_ITINERARY; 
                };
                const itineraryData = ref(generateDays());

                // Google Map Helper (Key Update)
                const getGoogleMapLink = (spot) => {
                    // 如果有特定連結，使用它
                    if (spot.mapLink && spot.mapLink.includes('http')) return spot.mapLink;
                    // 否則自動生成搜尋連結
                    const query = encodeURIComponent((spot.name || '') + ' ' + (spot.location || ''));
                    return `https://www.google.com/maps/search/?api=1&query=${query}`;
                };

                const getCategoryLabel = (type) => itineraryCategories.find(c => c.value === type)?.label || '其他';
                const getTransportIcon = (type) => ({'train':'ri-train-line', 'walk':'ri-walk-line', 'car':'ri-taxi-line'}[type] || 'ri-map-pin-line');

                // Shopping
                const shoppingList = ref([
                    { name: 'F1 鈴鹿限定 T-shirt', status: 'pending', id: 1 },
                    { name: '白色戀人', status: 'bought', id: 2 },
                    { name: '藥妝 (合利他命)', status: 'pending', id: 3 }
                ]);

                // Expense
                const expenseCategories = ['飲食', '交通', '購物', '住宿'];
                const expenseList = ref([
                    { category: '交通', name: 'NEX 車票', date: '03/21', amount: 3500, payment: '卡' },
                    { category: '飲食', name: '晚餐 拉麵', date: '03/21', amount: 1200, payment: '現' }
                ]);
                const totalExpense = computed(() => expenseList.value.reduce((s, i) => s + i.amount, 0));
                const getExpenseIcon = (c) => ({'交通':'ri-bus-line','飲食':'ri-restaurant-line','購物':'ri-shopping-bag-line'}[c] || 'ri-money-dollar-circle-line');

                // State for Modals
                const isSpotModalOpen = ref(false);
                const isExpenseModalOpen = ref(false);
                const isDeleteConfirmOpen = ref(false);
                const activeSpot = ref({});
                const activeExpense = ref({});
                const activeSpotIndex = ref(null);
                const isEditingSpot = computed(() => activeSpotIndex.value !== null);
                const spotModalTitle = computed(() => isEditingSpot.value ? '編輯行程' : '新增行程');
                
                // Info Data
                const exchangeRate = ref({ jpyToTwd: 0.22 });
                const jpyInput = ref(1000);
                const convertedTwd = computed(() => (jpyInput.value * exchangeRate.value.jpyToTwd).toFixed(0));
                const flightInfo = ref(BASE_ITINERARY[0].spots.filter(s=>s.type==='flight').concat(BASE_ITINERARY[BASE_ITINERARY.length-1].spots.filter(s=>s.type==='flight')).map(s=>({...s, from: s.name.split(' ')[1], to: s.desc.split(' ')[0], type: s.name.includes('桃園')?'departure':'return', date: s.name.includes('桃園')?'03/21':'04/04', arrivalTime: s.desc.slice(4,9)})));
                const locationInfo = ref([
                    { name: '秋葉原雷姆飯店', address: '東京都千代田区神田佐久間町1-6-5' },
                    { name: '名古屋三井花園飯店', address: '愛知県名古屋市中村区名駅4-11-27' },
                ]);

                // Methods
                const openSpotAdd = () => { activeSpot.value = {id:Date.now(), type:'activity', transport:{type:'train', time:'10m'}}; activeSpotIndex.value = null; isSpotModalOpen.value = true; };
                const openSpotEdit = (idx) => { activeSpot.value = JSON.parse(JSON.stringify(itineraryData.value[currentDay.value].spots[idx])); activeSpotIndex.value = idx; isSpotModalOpen.value = true; };
                const saveSpot = () => {
                    const list = itineraryData.value[currentDay.value].spots;
                    if(isEditingSpot.value) list[activeSpotIndex.value] = activeSpot.value;
                    else list.push(activeSpot.value);
                    isSpotModalOpen.value = false;
                };
                const confirmDeleteSpot = () => { isSpotModalOpen.value = false; isDeleteConfirmOpen.value = true; };
                const deleteSpot = () => { itineraryData.value[currentDay.value].spots.splice(activeSpotIndex.value, 1); isDeleteConfirmOpen.value = false; };
                
                const toggleExpenseModal = (mode, item, idx) => { activeExpense.value = mode==='add'?{category:'飲食', amount:''} : {...item}; isExpenseModalOpen.value = true; };
                const saveExpense = () => { expenseList.value.unshift(activeExpense.value); isExpenseModalOpen.value = false; };

                // Methods for Shop
                const toggleShopStatus = (idx) => { shoppingList.value[idx].status = shoppingList.value[idx].status==='pending'?'bought':'pending'; };

                return {
                    currentTopTab, topTabs, currentDay, itineraryData, filterType, itineraryCategories,
                    getCategoryLabel, getTransportIcon, getGoogleMapLink,
                    shoppingList, toggleShopStatus,
                    expenseList, totalExpense, getExpenseIcon,
                    isSpotModalOpen, activeSpot, isEditingSpot, spotModalTitle, openSpotAdd, openSpotEdit, saveSpot, confirmDeleteSpot, deleteSpot, isDeleteConfirmOpen,
                    isExpenseModalOpen, activeExpense, toggleExpenseModal, saveExpense,
                    exchangeRate, jpyInput, convertedTwd, flightInfo, locationInfo,
                    filterSpot: (type) => !filterType.value || type === filterType.value
                };
            }
        }).mount('#app');
    </script>
    
    <style>
        @supports (padding-top: env(safe-area-inset-top)) {
            body { padding-top: env(safe-area-inset-top); }
        }
    </style>
</body>
</html>